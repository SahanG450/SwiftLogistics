<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>SwiftLogistics System Architecture</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="pdf_styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () { mermaid.initialize({startOnLoad:true, theme: "neutral", flowchart: { useMaxWidth: true }}); });</script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">SwiftLogistics System Architecture</h1>
</header>
<h1
id="swiftlogistics-system-architecture-complete-data-flows-component-interactions">SwiftLogistics
System Architecture: Complete Data Flows &amp; Component
Interactions</h1>
<p><strong>Version:</strong> 1.0<br />
<strong>Last Updated:</strong> February 4, 2026</p>
<p>This document provides a comprehensive technical reference for
understanding how data flows through the SwiftLogistics system,
including JWT authentication, RabbitMQ message routing, event triggers,
and protocol adapters.</p>
<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<ol type="1">
<li><a href="#1-system-overview">System Overview</a></li>
<li><a href="#2-jwt-authentication-flow">JWT Authentication
Flow</a></li>
<li><a href="#3-rabbitmq-message-architecture">RabbitMQ Message
Architecture</a></li>
<li><a href="#4-complete-order-lifecycle">Complete Order
Lifecycle</a></li>
<li><a href="#5-event-driven-architecture">Event-Driven
Architecture</a></li>
<li><a href="#6-adapter-communication-patterns">Adapter Communication
Patterns</a></li>
<li><a href="#7-websocket-real-time-notifications">WebSocket Real-Time
Notifications</a></li>
<li><a href="#8-message-payload-specifications">Message Payload
Specifications</a></li>
</ol>
<hr />
<h2 id="overall-architecture">1. Overall Architecture</h2>
<h3 id="architectural-style">1.1 Architectural Style</h3>
<p>SwiftLogistics employs a <strong>hybrid architectural style</strong>
combining multiple patterns:</p>
<div class="mermaid">graph TB
    subgraph &quot;Architecture Layers&quot;
        Presentation[Presentation Layer&lt;br/&gt;React Web + React Native]
        Gateway[Gateway Layer&lt;br/&gt;API Gateway]
        Business[Business Logic Layer&lt;br/&gt;Orchestrator]
        Integration[Integration Layer&lt;br/&gt;Adapters CMS/ROS/WMS]
        External[External Systems&lt;br/&gt;Legacy/Modern Services]

        Presentation --&gt; Gateway
        Gateway --&gt; Business
        Business -.-&gt;|Events| MessageBroker[Message Broker&lt;br/&gt;RabbitMQ]
        MessageBroker -.-&gt; Integration
        Integration --&gt; External
    end

    subgraph &quot;Cross-Cutting Concerns&quot;
        Auth[Authentication JWT]
        Logging[Logging - Loguru]
        Monitoring[Health Checks]
        RealTime[Real-time - WebSocket]
    end

    Gateway -.-&gt; Auth
    Business -.-&gt; Logging
    Integration -.-&gt; Monitoring
    MessageBroker -.-&gt; RealTime</div>
<p><strong>Primary Architectural Patterns:</strong></p>
<ol type="1">
<li><strong>Microservices Architecture</strong>
<ul>
<li>Independent, loosely-coupled services</li>
<li>Single responsibility per service</li>
<li>Independent deployment and scaling</li>
<li>Polyglot persistence capable</li>
</ul></li>
<li><strong>Event-Driven Architecture (EDA)</strong>
<ul>
<li>Asynchronous communication via RabbitMQ</li>
<li>Pub/Sub pattern for broadcasting events</li>
<li>Event sourcing for audit trail</li>
<li>Eventual consistency model</li>
</ul></li>
<li><strong>Layered Architecture</strong>
<ul>
<li>Clear separation of concerns</li>
<li>Well-defined interfaces between layers</li>
<li>Dependency direction: top-down</li>
<li>Each layer has specific responsibilities</li>
</ul></li>
<li><strong>API Gateway Pattern</strong>
<ul>
<li>Single entry point for clients</li>
<li>Cross-cutting concerns (auth, rate limiting)</li>
<li>Request routing and composition</li>
<li>Protocol translation (if needed)</li>
</ul></li>
</ol>
<h3 id="architectural-layers">1.2 Architectural Layers</h3>
<div class="mermaid">graph TB
    subgraph &quot;Layer 1: Presentation&quot;
        Web[Web Portal&lt;br/&gt;React + Vite]
        Mobile[Mobile App&lt;br/&gt;React Native]
    end

    subgraph &quot;Layer 2: API Gateway&quot;
        GW[API Gateway&lt;br/&gt;FastAPI]
        Auth[JWT Auth]
        RateLimit[Rate Limiting]
        CORS[CORS Handler]
    end

    subgraph &quot;Layer 3: Business Logic&quot;
        ORC[Orchestrator&lt;br/&gt;Order Management]
        State[State Machine]
        Validation[Business Rules]
    end

    subgraph &quot;Layer 4: Integration&quot;
        CMSA[CMS Adapter&lt;br/&gt;SOAP Client]
        ROSA[ROS Adapter&lt;br/&gt;REST Client]
        WMSA[WMS Adapter&lt;br/&gt;TCP Client]
    end

    subgraph &quot;Layer 5: External Services&quot;
        CMS[Customer Mgmt&lt;br/&gt;Legacy SOAP]
        ROS[Route Optimization&lt;br/&gt;Modern REST]
        WMS[Warehouse Mgmt&lt;br/&gt;Proprietary TCP]
    end

    subgraph &quot;Supporting Services&quot;
        MQ[RabbitMQ&lt;br/&gt;Message Broker]
        DB[MongoDB&lt;br/&gt;Document Store]
        NS[Notification&lt;br/&gt;WebSocket Server]
    end

    Web --&gt; GW
    Mobile --&gt; GW
    GW --&gt; ORC
    ORC --&gt; MQ
    ORC --&gt; DB
    MQ --&gt; CMSA
    MQ --&gt; ROSA
    MQ --&gt; WMSA
    MQ --&gt; NS
    CMSA --&gt; CMS
    ROSA --&gt; ROS
    WMSA --&gt; WMS
    NS -.-&gt;|Push| Web
    NS -.-&gt;|Push| Mobile

    style Web fill:#e3f2fd
    style Mobile fill:#e3f2fd
    style GW fill:#fff3e0
    style ORC fill:#f3e5f5
    style MQ fill:#e8f5e9
    style DB fill:#fce4ec</div>
<p><strong>Layer Responsibilities:</strong></p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 26%" />
<col style="width: 30%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr class="header">
<th>Layer</th>
<th>Services</th>
<th>Responsibilities</th>
<th>Technologies</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Presentation</strong></td>
<td>Web Portal, Mobile App</td>
<td>User interface, user interactions</td>
<td>React, React Native</td>
</tr>
<tr class="even">
<td><strong>Gateway</strong></td>
<td>API Gateway</td>
<td>Auth, routing, rate limiting, CORS</td>
<td>FastAPI, JWT, SlowAPI</td>
</tr>
<tr class="odd">
<td><strong>Business Logic</strong></td>
<td>Orchestrator</td>
<td>Order processing, state management</td>
<td>FastAPI, Motor, Beanie</td>
</tr>
<tr class="even">
<td><strong>Integration</strong></td>
<td>CMS/ROS/WMS Adapters</td>
<td>Protocol translation, external calls</td>
<td>FastAPI, Pika, zeep/httpx/socket</td>
</tr>
<tr class="odd">
<td><strong>External</strong></td>
<td>CMS/ROS/WMS Services</td>
<td>Domain-specific operations</td>
<td>SOAP/REST/TCP</td>
</tr>
<tr class="even">
<td><strong>Supporting</strong></td>
<td>RabbitMQ, MongoDB, Notification</td>
<td>Messaging, persistence, real-time</td>
<td>RabbitMQ, MongoDB, Socket.IO</td>
</tr>
</tbody>
</table>
<h3 id="deployment-architecture">1.3 Deployment Architecture</h3>
<div class="mermaid">graph TB
    subgraph &quot;Client Layer - Outside Docker&quot;
        Browser[Web Browser&lt;br/&gt;localhost:5173]
        MobileDevice[Mobile Device&lt;br/&gt;Expo Go]
    end

    subgraph &quot;Docker Network: custom_network&quot;
        subgraph &quot;Gateway Services&quot;
            GW[api-gateway:3000&lt;br/&gt;Exposed: 3000]
        end

        subgraph &quot;Core Services&quot;
            ORC[orchestrator:3001&lt;br/&gt;Internal Only]
            NS[notification:3002&lt;br/&gt;Exposed: 3002]
        end

        subgraph &quot;Adapter Services&quot;
            CMSA[cms-adapter:4000&lt;br/&gt;Internal Only]
            ROSA[ros-adapter:4001&lt;br/&gt;Internal Only]
            WMSA[wms-adapter:4002&lt;br/&gt;Internal Only]
        end

        subgraph &quot;Mock Services&quot;
            CMS[cms-mock:3001&lt;br/&gt;Internal Only]
            ROS[ros-mock:3003&lt;br/&gt;Internal Only]
            WMS[wms-mock:4002&lt;br/&gt;Internal Only]
        end

        subgraph &quot;Infrastructure&quot;
            RMQ[rabbitmq:5672&lt;br/&gt;Exposed: 5672, 15672]
            MONGO[mongodb:27017&lt;br/&gt;Exposed: 27017]
        end
    end

    Browser --&gt;|HTTP/WS| GW
    Browser -.-&gt;|WebSocket| NS
    MobileDevice --&gt;|HTTP/WS| GW

    GW --&gt; ORC
    GW --&gt; CMS
    ORC --&gt; RMQ
    ORC --&gt; MONGO

    RMQ --&gt; CMSA
    RMQ --&gt; ROSA
    RMQ --&gt; WMSA
    RMQ --&gt; NS

    CMSA --&gt; CMS
    ROSA --&gt; ROS
    WMSA --&gt; WMS

    style Browser fill:#e3f2fd
    style MobileDevice fill:#e3f2fd
    style GW fill:#fff3e0
    style ORC fill:#f3e5f5
    style NS fill:#e8f5e9
    style RMQ fill:#fff3e0
    style MONGO fill:#fce4ec</div>
<p><strong>Port Mapping:</strong></p>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 18%" />
<col style="width: 17%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="header">
<th>Service</th>
<th>Internal Port</th>
<th>Exposed Port</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>api-gateway</strong></td>
<td>3000</td>
<td>3000</td>
<td>Client HTTP requests</td>
</tr>
<tr class="even">
<td><strong>notification-service</strong></td>
<td>3002</td>
<td>3002</td>
<td>WebSocket connections</td>
</tr>
<tr class="odd">
<td><strong>rabbitmq</strong></td>
<td>5672</td>
<td>5672</td>
<td>AMQP protocol</td>
</tr>
<tr class="even">
<td><strong>rabbitmq-admin</strong></td>
<td>15672</td>
<td>15672</td>
<td>Management UI</td>
</tr>
<tr class="odd">
<td><strong>mongodb</strong></td>
<td>27017</td>
<td>27017</td>
<td>Database access (dev)</td>
</tr>
<tr class="even">
<td><strong>orchestrator</strong></td>
<td>3001</td>
<td>-</td>
<td>Internal only</td>
</tr>
<tr class="odd">
<td><strong>cms-adapter</strong></td>
<td>4000</td>
<td>-</td>
<td>Internal only</td>
</tr>
<tr class="even">
<td><strong>ros-adapter</strong></td>
<td>4001</td>
<td>-</td>
<td>Internal only</td>
</tr>
<tr class="odd">
<td><strong>wms-adapter</strong></td>
<td>4002</td>
<td>-</td>
<td>Internal only</td>
</tr>
</tbody>
</table>
<p><strong>Network Isolation:</strong></p>
<ul>
<li>All services run in <code>custom_network</code> (bridge driver)</li>
<li>Services discover each other by container name (DNS)</li>
<li>Only necessary ports exposed to host</li>
<li>Internal services not accessible from outside Docker</li>
</ul>
<h3 id="scalability-considerations">1.4 Scalability Considerations</h3>
<p><strong>Horizontal Scaling Strategy:</strong></p>
<div class="mermaid">graph LR
    subgraph &quot;Load Balancer&quot;
        LB[Nginx/HAProxy]
    end

    subgraph &quot;Gateway Instances&quot;
        GW1[Gateway 1]
        GW2[Gateway 2]
        GW3[Gateway 3]
    end

    subgraph &quot;Orchestrator Instances&quot;
        ORC1[Orchestrator 1]
        ORC2[Orchestrator 2]
    end

    subgraph &quot;Adapter Instances&quot;
        CMSA1[CMS Adapter 1]
        CMSA2[CMS Adapter 2]
        ROSA1[ROS Adapter 1]
        ROSA2[ROS Adapter 2]
    end

    subgraph &quot;Shared Infrastructure&quot;
        RMQ[RabbitMQ Cluster]
        MONGO[MongoDB Replica Set]
    end

    LB --&gt; GW1
    LB --&gt; GW2
    LB --&gt; GW3

    GW1 --&gt; ORC1
    GW2 --&gt; ORC2
    GW3 --&gt; ORC1

    ORC1 --&gt; RMQ
    ORC2 --&gt; RMQ
    ORC1 --&gt; MONGO
    ORC2 --&gt; MONGO

    RMQ --&gt; CMSA1
    RMQ --&gt; CMSA2
    RMQ --&gt; ROSA1
    RMQ --&gt; ROSA2</div>
<p><strong>Scalability Per Service:</strong></p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 11%" />
<col style="width: 33%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr class="header">
<th>Service</th>
<th>Scaling Type</th>
<th>Strategy</th>
<th>Considerations</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>API Gateway</strong></td>
<td>Horizontal</td>
<td>Add instances behind load balancer</td>
<td>Stateless, rate limit needs shared cache</td>
</tr>
<tr class="even">
<td><strong>Orchestrator</strong></td>
<td>Horizontal</td>
<td>Multiple instances, shared DB</td>
<td>MongoDB handles concurrent writes</td>
</tr>
<tr class="odd">
<td><strong>Adapters</strong></td>
<td>Horizontal</td>
<td>Multiple consumers per queue</td>
<td>RabbitMQ distributes messages round-robin</td>
</tr>
<tr class="even">
<td><strong>Notification</strong></td>
<td>Vertical</td>
<td>Increase WebSocket connections</td>
<td>Socket.IO supports sticky sessions</td>
</tr>
<tr class="odd">
<td><strong>RabbitMQ</strong></td>
<td>Horizontal</td>
<td>Cluster mode</td>
<td>Mirror queues for HA</td>
</tr>
<tr class="even">
<td><strong>MongoDB</strong></td>
<td>Horizontal</td>
<td>Replica set, sharding</td>
<td>Shard by customerId or orderId</td>
</tr>
</tbody>
</table>
<p><strong>Current Bottlenecks:</strong></p>
<ol type="1">
<li><strong>MongoDB Writes</strong> - Orchestrator inserts every order
<ul>
<li><strong>Solution:</strong> Add read replicas for query
distribution</li>
</ul></li>
<li><strong>WebSocket Connections</strong> - Single notification service
<ul>
<li><strong>Solution:</strong> Use Socket.IO with Redis adapter for
multi-instance</li>
</ul></li>
<li><strong>External Services</strong> - CMS/ROS/WMS may be slow
<ul>
<li><strong>Solution:</strong> Timeouts, circuit breakers, caching</li>
</ul></li>
</ol>
<h3 id="quality-attributes">1.5 Quality Attributes</h3>
<p><strong>Performance:</strong></p>
<ul>
<li><strong>Target:</strong> &lt; 200ms response time for API calls
(P95)</li>
<li><strong>Achieved via:</strong>
<ul>
<li>AsyncIO for non-blocking I/O</li>
<li>Connection pooling (MongoDB: 100 connections)</li>
<li>Message queue for async processing</li>
<li>In-memory caching where applicable</li>
</ul></li>
</ul>
<p><strong>Reliability:</strong></p>
<ul>
<li><strong>Target:</strong> 99.9% uptime</li>
<li><strong>Achieved via:</strong>
<ul>
<li>Durable message queues (survive broker restart)</li>
<li>Persistent messages (written to disk)</li>
<li>Manual ACK (retry on failure)</li>
<li>Health check endpoints on all services</li>
<li>Docker restart policies (on-failure)</li>
</ul></li>
</ul>
<p><strong>Scalability:</strong></p>
<ul>
<li><strong>Target:</strong> Handle 1000+ orders/minute</li>
<li><strong>Achieved via:</strong>
<ul>
<li>Stateless services (easy horizontal scaling)</li>
<li>RabbitMQ queues (multiple consumers)</li>
<li>MongoDB connection pool</li>
<li>Docker Compose scales (–scale flag)</li>
</ul></li>
</ul>
<p><strong>Maintainability:</strong></p>
<ul>
<li><strong>Target:</strong> New features in &lt; 2 weeks</li>
<li><strong>Achieved via:</strong>
<ul>
<li>Modular service design</li>
<li>Clear separation of concerns</li>
<li>Comprehensive logging (Loguru)</li>
<li>Type hints (Python 3.13+)</li>
<li>Consistent code structure</li>
</ul></li>
</ul>
<p><strong>Security:</strong></p>
<ul>
<li><strong>Target:</strong> OWASP Top 10 compliance</li>
<li><strong>Achieved via:</strong>
<ul>
<li>JWT authentication (stateless)</li>
<li>bcrypt password hashing (salted)</li>
<li>Rate limiting (prevent abuse)</li>
<li>Input validation (Pydantic)</li>
<li>CORS restrictions</li>
<li>No secrets in code (environment variables)</li>
</ul></li>
</ul>
<p><strong>Observability:</strong></p>
<ul>
<li><strong>Achieved via:</strong>
<ul>
<li>Structured logging (JSON format)</li>
<li>Health check endpoints (/health)</li>
<li>RabbitMQ management UI (port 15672)</li>
<li>MongoDB monitoring (compass/shell)</li>
<li>Unique order IDs for tracing</li>
</ul></li>
</ul>
<h3 id="architectural-constraints">1.6 Architectural Constraints</h3>
<p><strong>Technical Constraints:</strong></p>
<ol type="1">
<li><strong>Python 3.13+</strong> - Required for latest type hints,
async features</li>
<li><strong>Docker</strong> - All services containerized, no native
deployment</li>
<li><strong>FastAPI</strong> - Chosen for async support, auto-docs</li>
<li><strong>RabbitMQ</strong> - AMQP protocol for messaging</li>
<li><strong>MongoDB</strong> - Document store for flexible schema</li>
</ol>
<p><strong>Business Constraints:</strong></p>
<ol type="1">
<li><strong>Legacy Integration</strong> - Must support existing CMS
(SOAP)</li>
<li><strong>Real-time Updates</strong> - Clients need instant
notification</li>
<li><strong>Protocol Support</strong> - SOAP, REST, TCP all
required</li>
<li><strong>Audit Trail</strong> - All orders must be logged</li>
</ol>
<p><strong>Design Constraints:</strong></p>
<ol type="1">
<li><strong>Stateless Services</strong> - For horizontal scaling</li>
<li><strong>Event-Driven</strong> - For loose coupling</li>
<li><strong>Async-First</strong> - For high throughput</li>
<li><strong>Container-Native</strong> - For portability</li>
</ol>
<h3 id="architectural-decisions">1.7 Architectural Decisions</h3>
<p><strong>Key Decisions and Rationale:</strong></p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 17%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>Decision</th>
<th>Alternative Considered</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>FastAPI over Flask</strong></td>
<td>Flask with Celery</td>
<td>FastAPI has native async, auto-docs, type validation</td>
</tr>
<tr class="even">
<td><strong>RabbitMQ over Kafka</strong></td>
<td>Apache Kafka</td>
<td>Simpler setup, sufficient for current scale, better at-least-once
delivery</td>
</tr>
<tr class="odd">
<td><strong>MongoDB over PostgreSQL</strong></td>
<td>PostgreSQL</td>
<td>Flexible schema for evolving order structure, better for document
storage</td>
</tr>
<tr class="even">
<td><strong>JWT over Sessions</strong></td>
<td>Server-side sessions</td>
<td>Stateless, scalable, works across services</td>
</tr>
<tr class="odd">
<td><strong>Docker Compose over K8s</strong></td>
<td>Kubernetes</td>
<td>Simpler for development, sufficient for current deployment</td>
</tr>
<tr class="even">
<td><strong>Pika over aio-pika</strong></td>
<td>aio-pika (async)</td>
<td>More mature, simpler threading model for our use case</td>
</tr>
<tr class="odd">
<td><strong>WebSocket over SSE</strong></td>
<td>Server-Sent Events</td>
<td>Bidirectional, better library support (Socket.IO)</td>
</tr>
<tr class="even">
<td><strong>Beanie over PyMongo</strong></td>
<td>Raw PyMongo</td>
<td>Type-safe ODM, better DX, validation built-in</td>
</tr>
</tbody>
</table>
<h3 id="future-architecture-evolution">1.8 Future Architecture
Evolution</h3>
<p><strong>Planned Enhancements:</strong></p>
<div class="mermaid">graph TB
    Current[Current Architecture&lt;br/&gt;Monolithic per layer]

    Future1[Phase 1: Horizontal Scaling&lt;br/&gt;Load balancer + instances]
    Future2[Phase 2: Service Mesh&lt;br/&gt;Istio for observability]
    Future3[Phase 3: Multi-Region&lt;br/&gt;Geo-distributed deployment]

    Current --&gt; Future1
    Future1 --&gt; Future2
    Future2 --&gt; Future3

    style Current fill:#e3f2fd
    style Future1 fill:#fff3e0
    style Future2 fill:#f3e5f5
    style Future3 fill:#e8f5e9</div>
<p><strong>Phase 1: Horizontal Scaling</strong> (Next 3 months)</p>
<ul>
<li>Add Nginx load balancer</li>
<li>Scale API Gateway to 3+ instances</li>
<li>RabbitMQ cluster (3 nodes)</li>
<li>MongoDB replica set (3 nodes)</li>
<li>Redis for shared rate limiting</li>
</ul>
<p><strong>Phase 2: Observability &amp; Service Mesh</strong> (6
months)</p>
<ul>
<li>Deploy Istio service mesh</li>
<li>Distributed tracing (Jaeger/Zipkin)</li>
<li>Metrics collection (Prometheus)</li>
<li>Dashboards (Grafana)</li>
<li>Circuit breaker policies</li>
</ul>
<p><strong>Phase 3: Multi-Region</strong> (12 months)</p>
<ul>
<li>Deploy to multiple AWS regions</li>
<li>Global load balancing (Route53)</li>
<li>Cross-region replication (MongoDB)</li>
<li>Edge caching (CloudFront)</li>
<li>DR strategy</li>
</ul>
<hr />
<h2 id="system-overview">2. System Overview</h2>
<h3 id="component-architecture">1.1 Component Architecture</h3>
<div class="mermaid">graph TB
    subgraph &quot;Client Layer&quot;
        UI[React Web Portal]
        Mobile[React Native App]
    end

    subgraph &quot;Gateway Layer&quot;
        GW[API Gateway&lt;br/&gt;Port: 3000]
    end

    subgraph &quot;Business Logic Layer&quot;
        ORC[Orchestrator&lt;br/&gt;Port: 3001]
        NS[Notification Service&lt;br/&gt;Port: 3002]
    end

    subgraph &quot;Message Broker&quot;
        RMQ[RabbitMQ&lt;br/&gt;Port: 5672]
    end

    subgraph &quot;Adapter Layer&quot;
        CMSA[CMS Adapter&lt;br/&gt;SOAP]
        ROSA[ROS Adapter&lt;br/&gt;REST]
        WMSA[WMS Adapter&lt;br/&gt;TCP]
    end

    subgraph &quot;External/Mock Systems&quot;
        CMS[CMS Mock&lt;br/&gt;Port: 3001]
        ROS[ROS Mock&lt;br/&gt;Port: 3003]
        WMS[WMS Mock&lt;br/&gt;Port: 4002]
    end

    subgraph &quot;Data Layer&quot;
        MONGO[(MongoDB&lt;br/&gt;Port: 27017)]
    end

    UI --&gt;|HTTPS| GW
    Mobile --&gt;|HTTPS| GW
    UI -.-&gt;|WebSocket| NS
    Mobile -.-&gt;|WebSocket| NS

    GW --&gt;|HTTP| ORC
    GW --&gt;|HTTP| CMS

    ORC --&gt;|Publish| RMQ
    ORC --&gt;|Read/Write| MONGO

    RMQ --&gt;|Subscribe| CMSA
    RMQ --&gt;|Subscribe| ROSA
    RMQ --&gt;|Subscribe| WMSA
    RMQ --&gt;|Subscribe| NS

    CMSA --&gt;|SOAP| CMS
    ROSA --&gt;|REST| ROS
    WMSA --&gt;|TCP| WMS

    CMSA --&gt;|Publish| RMQ
    ROSA --&gt;|Publish| RMQ
    WMSA --&gt;|Publish| RMQ</div>
<h3 id="technology-stack">1.2 Technology Stack</h3>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 24%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="header">
<th>Layer</th>
<th>Technology</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Frontend</strong></td>
<td>React + Vite</td>
<td>Web client portal</td>
</tr>
<tr class="even">
<td><strong>Mobile</strong></td>
<td>React Native</td>
<td>Driver mobile app</td>
</tr>
<tr class="odd">
<td><strong>API Gateway</strong></td>
<td>FastAPI + SlowAPI</td>
<td>Authentication, rate limiting, routing</td>
</tr>
<tr class="even">
<td><strong>Orchestrator</strong></td>
<td>FastAPI + Motor</td>
<td>Business logic, state management</td>
</tr>
<tr class="odd">
<td><strong>Message Broker</strong></td>
<td>RabbitMQ (Pika)</td>
<td>Asynchronous event distribution</td>
</tr>
<tr class="even">
<td><strong>Notification</strong></td>
<td>FastAPI + Socket.IO</td>
<td>Real-time WebSocket push</td>
</tr>
<tr class="odd">
<td><strong>Adapters</strong></td>
<td>FastAPI + Pika</td>
<td>Protocol translation</td>
</tr>
<tr class="even">
<td><strong>Database</strong></td>
<td>MongoDB</td>
<td>Order and state persistence</td>
</tr>
<tr class="odd">
<td><strong>Authentication</strong></td>
<td>JWT (python-jose)</td>
<td>Stateless token-based auth</td>
</tr>
<tr class="even">
<td><strong>Password Hashing</strong></td>
<td>bcrypt (passlib)</td>
<td>Secure credential storage</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="jwt-authentication-flow">2. JWT Authentication Flow</h2>
<h3 id="authentication-sequence">2.1 Authentication Sequence</h3>
<div class="mermaid">sequenceDiagram
    participant U as User (Frontend)
    participant GW as API Gateway
    participant CMS as CMS Mock
    participant JWT as JWT Module

    U-&gt;&gt;GW: POST /api/auth/login&lt;br/&gt;{email, password}

    Note over GW: Rate limit check&lt;br/&gt;(5 req/min)

    GW-&gt;&gt;CMS: POST /api/auth/login&lt;br/&gt;{username, password}

    Note over CMS: 1. Hash password with bcrypt&lt;br/&gt;2. Compare with DB hash&lt;br/&gt;3. Validate credentials

    alt Valid Credentials
        CMS--&gt;&gt;GW: 200 OK&lt;br/&gt;{id, email, role}

        Note over GW,JWT: JWT Generation Process
        GW-&gt;&gt;JWT: create_access_token({&lt;br/&gt;userId, email, role&lt;br/&gt;})

        Note over JWT: 1. Copy payload&lt;br/&gt;2. Add expiration (24h)&lt;br/&gt;3. Sign with SECRET_KEY&lt;br/&gt;4. Algorithm: HS256

        JWT--&gt;&gt;GW: JWT Token String

        GW--&gt;&gt;U: 200 OK&lt;br/&gt;{token, user}

    else Invalid Credentials
        CMS--&gt;&gt;GW: 401 Unauthorized
        GW--&gt;&gt;U: 401 Unauthorized&lt;br/&gt;&quot;Invalid credentials&quot;
    end</div>
<h3 id="jwt-token-structure">2.2 JWT Token Structure</h3>
<p><strong>Header:</strong></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;alg&quot;</span><span class="fu">:</span> <span class="st">&quot;HS256&quot;</span><span class="fu">,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;typ&quot;</span><span class="fu">:</span> <span class="st">&quot;JWT&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<p><strong>Payload:</strong></p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;userId&quot;</span><span class="fu">:</span> <span class="st">&quot;usr_12345&quot;</span><span class="fu">,</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;john@example.com&quot;</span><span class="fu">,</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;role&quot;</span><span class="fu">:</span> <span class="st">&quot;client&quot;</span><span class="fu">,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;exp&quot;</span><span class="fu">:</span> <span class="dv">1707091868</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<p><strong>Signature:</strong></p>
<pre><code>HMACSHA256(
  base64UrlEncode(header) + &quot;.&quot; +
  base64UrlEncode(payload),
  SECRET_KEY
)</div>
<h3 id="authentication-code-implementation">2.3 Authentication Code
Implementation</h3>
<p><strong>Token Creation</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/auth.py#L33-L54">common/auth.py</a>):</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_access_token(data: <span class="bu">dict</span>, expires_delta: Optional[timedelta] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Create JWT access token with HS256 algorithm.&quot;&quot;&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    to_encode <span class="op">=</span> data.copy()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expires_delta:</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        expire <span class="op">=</span> datetime.utcnow() <span class="op">+</span> expires_delta</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        expire <span class="op">=</span> datetime.utcnow() <span class="op">+</span> timedelta(hours<span class="op">=</span>ACCESS_TOKEN_EXPIRE_HOURS)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    to_encode.update({<span class="st">&quot;exp&quot;</span>: expire})</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    encoded_jwt <span class="op">=</span> jwt.encode(to_encode, SECRET_KEY, algorithm<span class="op">=</span>ALGORITHM)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> encoded_jwt</span></div></div>
<p><strong>Token Validation</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/auth.py#L57-L78">common/auth.py</a>):</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode_access_token(token: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Decode and validate JWT token.&quot;&quot;&quot;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        payload <span class="op">=</span> jwt.decode(token, SECRET_KEY, algorithms<span class="op">=</span>[ALGORITHM])</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> payload</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> JWTError <span class="im">as</span> e:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span>status.HTTP_401_UNAUTHORIZED,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            detail<span class="op">=</span><span class="st">&quot;Invalid or expired token&quot;</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">=</span>{<span class="st">&quot;WWW-Authenticate&quot;</span>: <span class="st">&quot;Bearer&quot;</span>},</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        )</span></div></div>
<h3 id="protected-route-pattern">2.4 Protected Route Pattern</h3>
<div class="mermaid">sequenceDiagram
    participant U as User
    participant GW as API Gateway
    participant MW as Auth Middleware
    participant ORC as Orchestrator

    U-&gt;&gt;GW: POST /api/orders&lt;br/&gt;Authorization: Bearer {token}

    GW-&gt;&gt;MW: Extract token from header

    Note over MW: 1. Parse &quot;Bearer {token}&quot;&lt;br/&gt;2. Decode JWT&lt;br/&gt;3. Verify signature&lt;br/&gt;4. Check expiration

    alt Valid Token
        MW-&gt;&gt;MW: Inject user data&lt;br/&gt;into request.state
        MW-&gt;&gt;ORC: Forward request&lt;br/&gt;with user context
        ORC--&gt;&gt;GW: Process &amp; respond
        GW--&gt;&gt;U: 200 OK
    else Invalid/Expired Token
        MW--&gt;&gt;U: 401 Unauthorized&lt;br/&gt;&quot;Invalid or expired token&quot;
    end</div>
<h3 id="password-security">2.5 Password Security</h3>
<p><strong>Hashing Process:</strong></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using bcrypt via passlib</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>pwd_context <span class="op">=</span> CryptContext(schemes<span class="op">=</span>[<span class="st">&quot;bcrypt&quot;</span>], deprecated<span class="op">=</span><span class="st">&quot;auto&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># During registration</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>hashed_password <span class="op">=</span> pwd_context.<span class="bu">hash</span>(<span class="st">&quot;user_plain_password&quot;</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Stored in database: $2b$12$XYZ...</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># During login</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>is_valid <span class="op">=</span> pwd_context.verify(<span class="st">&quot;user_input_password&quot;</span>, hashed_password)</span></div></div>
<p><strong>Key Features:</strong></p>
<ul>
<li><strong>Salt:</strong> Automatically generated per password</li>
<li><strong>Work Factor:</strong> 12 rounds (default bcrypt)</li>
<li><strong>Algorithm:</strong> bcrypt (Blowfish cipher)</li>
<li><strong>Storage:</strong> Never store plaintext passwords</li>
</ul>
<hr />
<h2 id="rabbitmq-message-architecture">3. RabbitMQ Message
Architecture</h2>
<h3 id="exchange-and-queue-topology">3.1 Exchange and Queue
Topology</h3>
<div class="mermaid">graph LR
    subgraph &quot;Publishers&quot;
        ORC[Orchestrator]
        CMSA[CMS Adapter]
        ROSA[ROS Adapter]
        WMSA[WMS Adapter]
    end

    subgraph &quot;RabbitMQ Broker&quot;
        OE[order_exchange&lt;br/&gt;Type: fanout&lt;br/&gt;Durable: true]
        EE[events_exchange&lt;br/&gt;Type: fanout&lt;br/&gt;Durable: true]

        CQ[cms_order_queue&lt;br/&gt;Durable: true]
        RQ[ros_order_queue&lt;br/&gt;Durable: true]
        WQ[wms_order_queue&lt;br/&gt;Durable: true]
        NQ[notification_events_queue&lt;br/&gt;Durable: true]
    end

    subgraph &quot;Consumers&quot;
        CMSA2[CMS Adapter]
        ROSA2[ROS Adapter]
        WMSA2[WMS Adapter]
        NS[Notification Service]
    end

    ORC --&gt;|Publish| OE
    OE --&gt;|Binding| CQ
    OE --&gt;|Binding| RQ
    OE --&gt;|Binding| WQ

    CQ --&gt;|Consume| CMSA2
    RQ --&gt;|Consume| ROSA2
    WQ --&gt;|Consume| WMSA2

    CMSA --&gt;|Publish| EE
    ROSA --&gt;|Publish| EE
    WMSA --&gt;|Publish| EE
    ORC --&gt;|Publish| EE

    EE --&gt;|Binding| NQ
    NQ --&gt;|Consume| NS</div>
<h3 id="rabbitmq-connection-configuration">3.2 RabbitMQ Connection
Configuration</h3>
<p><strong>Connection Establishment</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/messaging.py#L18-L35">common/messaging.py</a>):</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="ex">connect</span>(<span class="va">self</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Connect to RabbitMQ with blocking connection.&quot;&quot;&quot;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;Connecting to RabbitMQ...&quot;</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse connection URL: amqp://admin:admin123@rabbitmq:5672</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> pika.URLParameters(<span class="va">self</span>.rabbitmq_url)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    params.heartbeat <span class="op">=</span> <span class="dv">600</span>  <span class="co"># Keep-alive every 10 minutes</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    params.blocked_connection_timeout <span class="op">=</span> <span class="dv">300</span>  <span class="co"># 5 minute timeout</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.connection <span class="op">=</span> pika.BlockingConnection(params)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.channel <span class="op">=</span> <span class="va">self</span>.connection.channel()</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;✓ RabbitMQ connected successfully&quot;</span>)</span></div></div>
<h3 id="exchange-declaration">3.3 Exchange Declaration</h3>
<p><strong>Fanout Exchange</strong> (broadcasts to all bound
queues):</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> declare_exchange(<span class="va">self</span>, exchange_name: <span class="bu">str</span>, exchange_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;fanout&#39;</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Declare a durable exchange.&quot;&quot;&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.channel.exchange_declare(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        exchange<span class="op">=</span>exchange_name,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        exchange_type<span class="op">=</span>exchange_type,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        durable<span class="op">=</span><span class="va">True</span>  <span class="co"># Survives broker restart</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    )</span></div></div>
<p><strong>Exchange Types in SwiftLogistics:</strong></p>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 8%" />
<col style="width: 67%" />
</colgroup>
<thead>
<tr class="header">
<th>Exchange</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>order_exchange</code></td>
<td>fanout</td>
<td>Broadcast new orders to all adapters</td>
</tr>
<tr class="even">
<td><code>events_exchange</code></td>
<td>fanout</td>
<td>Broadcast status updates to notification service</td>
</tr>
</tbody>
</table>
<h3 id="queue-declaration-and-binding">3.4 Queue Declaration and
Binding</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Declare durable queue</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>queue_name <span class="op">=</span> mq.declare_queue(<span class="st">&#39;cms_order_queue&#39;</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: Queue persists even if broker restarts</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind queue to exchange</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>mq.bind_queue(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    queue_name<span class="op">=</span><span class="st">&#39;cms_order_queue&#39;</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    exchange_name<span class="op">=</span><span class="st">&#39;order_exchange&#39;</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    routing_key<span class="op">=</span><span class="st">&#39;&#39;</span>  <span class="co"># Empty for fanout</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>)</span></div></div>
<h3 id="message-publishing">3.5 Message Publishing</h3>
<p><strong>Publishing with Persistence</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/messaging.py#L96-L117">common/messaging.py</a>):</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> publish(<span class="va">self</span>, exchange_name: <span class="bu">str</span>, message: <span class="bu">dict</span>, routing_key: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;&#39;</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Publish persistent message to exchange.&quot;&quot;&quot;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.channel.basic_publish(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        exchange<span class="op">=</span>exchange_name,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        routing_key<span class="op">=</span>routing_key,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        body<span class="op">=</span>json.dumps(message),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">=</span>pika.BasicProperties(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>            delivery_mode<span class="op">=</span><span class="dv">2</span>,  <span class="co"># Persistent message</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>            content_type<span class="op">=</span><span class="st">&#39;application/json&#39;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    )</span></div></div>
<h3 id="message-consumption">3.6 Message Consumption</h3>
<p><strong>Consumer Pattern with Manual ACK</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/messaging.py#L119-L139">common/messaging.py</a>):</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> consume(<span class="va">self</span>, queue_name: <span class="bu">str</span>, callback: Callable, prefetch_count: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Start consuming with QoS and manual acknowledgment.&quot;&quot;&quot;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.channel.basic_qos(prefetch_count<span class="op">=</span>prefetch_count)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.channel.basic_consume(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        queue<span class="op">=</span>queue_name,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        on_message_callback<span class="op">=</span>callback,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        auto_ack<span class="op">=</span><span class="va">False</span>  <span class="co"># Manual acknowledgment required</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.channel.start_consuming()</span></div></div>
<p><strong>Callback Implementation Example</strong> (CMS Adapter):</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> json.loads(body)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="ss">f&quot;Processing order: </span><span class="sc">{</span>order[<span class="st">&#39;orderId&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process the order (call external service)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        process_order_in_cms(order)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Acknowledge successful processing</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f&quot;Error processing order: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Requeue message for retry</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        ch.basic_nack(delivery_tag<span class="op">=</span>method.delivery_tag, requeue<span class="op">=</span><span class="va">True</span>)</span></div></div>
<h3 id="reliability-mechanisms">3.7 Reliability Mechanisms</h3>
<p><strong>Features ensuring message reliability:</strong></p>
<ol type="1">
<li><strong>Durable Exchanges:</strong> <code>durable=True</code> -
survive broker restart</li>
<li><strong>Durable Queues:</strong> <code>durable=True</code> - persist
to disk</li>
<li><strong>Persistent Messages:</strong> <code>delivery_mode=2</code> -
written to disk</li>
<li><strong>Manual ACK:</strong> Messages only removed after explicit
acknowledgment</li>
<li><strong>Requeue on Failure:</strong>
<code>basic_nack(requeue=True)</code> returns message to queue</li>
<li><strong>Heartbeats:</strong> <code>heartbeat=600</code> keeps
connection alive</li>
<li><strong>Prefetch Count:</strong> <code>prefetch_count=1</code>
prevents worker overload</li>
</ol>
<h3 id="threading-model">3.8 Threading Model</h3>
<p>RabbitMQ consumers run in <strong>separate daemon threads</strong> to
avoid blocking FastAPI’s async event loop:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Main thread: Runs FastAPI (HTTP endpoints)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Background thread: Runs Pika consumer (blocking I/O)</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> consume_orders():</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    mq.<span class="ex">connect</span>()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    mq.declare_exchange(<span class="st">&#39;order_exchange&#39;</span>, <span class="st">&#39;fanout&#39;</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    queue_name <span class="op">=</span> mq.declare_queue(<span class="st">&#39;cms_order_queue&#39;</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    mq.bind_queue(queue_name, <span class="st">&#39;order_exchange&#39;</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    mq.consume(queue_name, callback)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>consumer_thread <span class="op">=</span> threading.Thread(target<span class="op">=</span>consume_orders, daemon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>consumer_thread.start()</span></div></div>
<hr />
<h2 id="complete-order-lifecycle">4. Complete Order Lifecycle</h2>
<h3 id="end-to-end-order-processing">4.1 End-to-End Order
Processing</h3>
<div class="mermaid">sequenceDiagram
    participant U as User&lt;br/&gt;(Frontend)
    participant GW as API Gateway
    participant ORC as Orchestrator
    participant DB as MongoDB
    participant MQ as RabbitMQ
    participant CMSA as CMS Adapter
    participant ROSA as ROS Adapter
    participant WMSA as WMS Adapter
    participant CMS as CMS Mock
    participant ROS as ROS Mock
    participant WMS as WMS Mock
    participant NS as Notification&lt;br/&gt;Service

    rect rgb(200, 220, 250)
        Note over U,GW: Phase 1: User Submission
        U-&gt;&gt;GW: POST /api/orders&lt;br/&gt;Authorization: Bearer {token}
        Note over GW: Validate JWT&lt;br/&gt;Check rate limit
        GW-&gt;&gt;ORC: Forward order request
    end

    rect rgb(220, 250, 220)
        Note over ORC,MQ: Phase 2: Orchestration
        ORC-&gt;&gt;ORC: Generate order_id
        ORC-&gt;&gt;DB: Insert order&lt;br/&gt;status: RECEIVED
        DB--&gt;&gt;ORC: OK

        ORC-&gt;&gt;MQ: Publish to&lt;br/&gt;order_exchange
        Note over MQ: Fanout to 3 queues:&lt;br/&gt;cms_order_queue&lt;br/&gt;ros_order_queue&lt;br/&gt;wms_order_queue

        ORC-&gt;&gt;MQ: Publish to&lt;br/&gt;events_exchange&lt;br/&gt;type: ORDER_CREATED

        ORC--&gt;&gt;GW: 202 Accepted&lt;br/&gt;{orderId, status}
        GW--&gt;&gt;U: 202 Accepted
    end

    rect rgb(255, 240, 220)
        Note over MQ,WMS: Phase 3: Parallel Adapter Processing

        par CMS Processing
            MQ-&gt;&gt;CMSA: Consume from&lt;br/&gt;cms_order_queue
            CMSA-&gt;&gt;CMS: SOAP Request&lt;br/&gt;(Customer validation)
            CMS--&gt;&gt;CMSA: SOAP Response
            CMSA-&gt;&gt;MQ: Publish to&lt;br/&gt;events_exchange&lt;br/&gt;type: cms.success
            CMSA-&gt;&gt;CMSA: ACK message
        and ROS Processing
            MQ-&gt;&gt;ROSA: Consume from&lt;br/&gt;ros_order_queue
            ROSA-&gt;&gt;ROS: REST POST&lt;br/&gt;(Route optimization)
            ROS--&gt;&gt;ROSA: 200 OK&lt;br/&gt;{route, ETA}
            ROSA-&gt;&gt;MQ: Publish to&lt;br/&gt;events_exchange&lt;br/&gt;type: ros.success
            ROSA-&gt;&gt;ROSA: ACK message
        and WMS Processing
            MQ-&gt;&gt;WMSA: Consume from&lt;br/&gt;wms_order_queue
            WMSA-&gt;&gt;WMS: TCP Socket&lt;br/&gt;(Inventory check)
            WMS--&gt;&gt;WMSA: ACK + Inventory OK
            WMSA-&gt;&gt;MQ: Publish to&lt;br/&gt;events_exchange&lt;br/&gt;type: wms.success
            WMSA-&gt;&gt;WMSA: ACK message
        end
    end

    rect rgb(240, 220, 255)
        Note over MQ,U: Phase 4: Real-time Notification
        MQ-&gt;&gt;NS: Consume from&lt;br/&gt;notification_events_queue
        Note over NS: Bridge thread&lt;br/&gt;to async context
        NS-&gt;&gt;U: WebSocket emit&lt;br/&gt;&#39;order-update&#39;&lt;br/&gt;{orderId, status, message}
        Note over U: UI updates&lt;br/&gt;automatically
    end</div>
<h3 id="order-creation-code-flow">4.2 Order Creation Code Flow</h3>
<p><strong>Step 1: Order Submission</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/orchestrator/routes/orders.py#L16-L76">orchestrator/routes/orders.py</a>):</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="at">@router.post</span>(<span class="st">&quot;&quot;</span>, response_model<span class="op">=</span>OrderResponse, status_code<span class="op">=</span>status.HTTP_202_ACCEPTED)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> create_order(order_request: OrderCreateRequest):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Generate unique order ID</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    order_id <span class="op">=</span> create_order_id()  <span class="co"># e.g., &quot;ORD-20260204-ABC123&quot;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Create order document</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> Order(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        orderId<span class="op">=</span>order_id,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        customerId<span class="op">=</span>order_request.<span class="bu">dict</span>().get(<span class="st">&quot;customerId&quot;</span>, <span class="st">&quot;unknown&quot;</span>),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        pickupLocation<span class="op">=</span>order_request.pickupLocation.<span class="bu">dict</span>(),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        deliveryAddress<span class="op">=</span>order_request.deliveryAddress.<span class="bu">dict</span>(),</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        packageDetails<span class="op">=</span>order_request.packageDetails.<span class="bu">dict</span>(),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        scheduledPickupTime<span class="op">=</span>order_request.scheduledPickupTime,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        specialInstructions<span class="op">=</span>order_request.specialInstructions,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        status<span class="op">=</span><span class="st">&quot;RECEIVED&quot;</span>,</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        createdAt<span class="op">=</span>datetime.utcnow()</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Persist to MongoDB</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> order.insert()</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Publish to order_exchange (fanout to all adapters)</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    message_queue.publish(</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        exchange_name<span class="op">=</span><span class="st">&#39;order_exchange&#39;</span>,</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        message<span class="op">=</span>{</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;orderId&quot;</span>: order_id,</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;customerId&quot;</span>: order.customerId,</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;pickupLocation&quot;</span>: order.pickupLocation,</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;deliveryAddress&quot;</span>: order.deliveryAddress,</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;packageDetails&quot;</span>: order.packageDetails,</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timestamp&quot;</span>: order.createdAt.isoformat()</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Publish creation event to notification service</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    message_queue.publish(</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>        exchange_name<span class="op">=</span><span class="st">&#39;events_exchange&#39;</span>,</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>        message<span class="op">=</span>{</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span>: <span class="st">&quot;ORDER_CREATED&quot;</span>,</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;data&quot;</span>: {</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;orderId&quot;</span>: order_id,</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;status&quot;</span>: <span class="st">&quot;RECEIVED&quot;</span>,</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;message&quot;</span>: <span class="st">&quot;Order received and being processed&quot;</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat()</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Return immediately (async processing)</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> OrderResponse(</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        orderId<span class="op">=</span>order_id,</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        status<span class="op">=</span><span class="st">&quot;RECEIVED&quot;</span>,</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>        message<span class="op">=</span><span class="st">&quot;Order received and being processed&quot;</span>,</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        customerId<span class="op">=</span>order.customerId,</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>        createdAt<span class="op">=</span>order.createdAt</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    )</span></div></div>
<p><strong>Why 202 Accepted?</strong><br />
The orchestrator returns HTTP 202 (Accepted) instead of 200 (OK)
because:</p>
<ul>
<li>Processing is <strong>asynchronous</strong> (adapters work in
parallel)</li>
<li>Final order state is not yet determined</li>
<li>Client receives immediate feedback while processing continues</li>
<li>Updates delivered via WebSocket</li>
</ul>
<hr />
<h2 id="event-driven-architecture">5. Event-Driven Architecture</h2>
<h3 id="event-catalog">5.1 Event Catalog</h3>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 12%" />
<col style="width: 24%" />
<col style="width: 28%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Event Type</th>
<th>Publisher</th>
<th>Trigger</th>
<th>Payload</th>
<th>Consumers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>ORDER_CREATED</code></td>
<td>Orchestrator</td>
<td>User creates order</td>
<td><code>{orderId, status, message}</code></td>
<td>Notification Service</td>
</tr>
<tr class="even">
<td><code>order.new</code></td>
<td>Orchestrator</td>
<td>Order published to queue</td>
<td>Full order object</td>
<td>CMS/ROS/WMS Adapters</td>
</tr>
<tr class="odd">
<td><code>cms.success</code></td>
<td>CMS Adapter</td>
<td>CMS SOAP call succeeds</td>
<td><code>{orderId, status, cmsData}</code></td>
<td>Notification Service</td>
</tr>
<tr class="even">
<td><code>ros.success</code></td>
<td>ROS Adapter</td>
<td>ROS REST call succeeds</td>
<td><code>{orderId, route, eta}</code></td>
<td>Notification Service</td>
</tr>
<tr class="odd">
<td><code>wms.success</code></td>
<td>WMS Adapter</td>
<td>WMS TCP ACK received</td>
<td><code>{orderId, inventory}</code></td>
<td>Notification Service</td>
</tr>
<tr class="even">
<td><code>order.update</code></td>
<td>Any Adapter</td>
<td>Generic status change</td>
<td><code>{orderId, status, details}</code></td>
<td>Notification Service</td>
</tr>
</tbody>
</table>
<h3 id="event-trigger-flow">5.2 Event Trigger Flow</h3>
<div class="mermaid">stateDiagram-v2
    [*] --&gt; RECEIVED: User submits order

    RECEIVED --&gt; PROCESSING: Orchestrator publishes&lt;br/&gt;to order_exchange

    state PROCESSING {
        [*] --&gt; CMS_Pending
        [*] --&gt; ROS_Pending
        [*] --&gt; WMS_Pending

        CMS_Pending --&gt; CMS_Complete: CMS Adapter processes
        ROS_Pending --&gt; ROS_Complete: ROS Adapter processes
        WMS_Pending --&gt; WMS_Complete: WMS Adapter processes
    }

    PROCESSING --&gt; CONFIRMED: All adapters complete
    CONFIRMED --&gt; ASSIGNED: Driver assignment
    ASSIGNED --&gt; IN_TRANSIT: Driver picks up
    IN_TRANSIT --&gt; DELIVERED: Order delivered
    DELIVERED --&gt; [*]

    PROCESSING --&gt; FAILED: Any adapter fails
    FAILED --&gt; [*]</div>
<h3 id="event-publishing-pattern">5.3 Event Publishing Pattern</h3>
<p><strong>Event Structure:</strong></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;ORDER_CREATED&quot;</span><span class="fu">,</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;RECEIVED&quot;</span><span class="fu">,</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Order received and being processed&quot;</span><span class="fu">,</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:30.123Z&quot;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:30.123Z&quot;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<p><strong>Publishing Code:</strong></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>message_queue.publish(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    exchange_name<span class="op">=</span><span class="st">&#39;events_exchange&#39;</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    message<span class="op">=</span>{</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span>: <span class="st">&quot;ORDER_CREATED&quot;</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;data&quot;</span>: {</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;orderId&quot;</span>: order_id,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;status&quot;</span>: <span class="st">&quot;RECEIVED&quot;</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;message&quot;</span>: <span class="st">&quot;Order received and being processed&quot;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat()</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>)</span></div></div>
<h3 id="event-consumption-in-notification-service">5.4 Event Consumption
in Notification Service</h3>
<p><strong>Consumer Thread</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/notification-service/main.py#L40-L57">notification-service/main.py</a>):</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> consume_events():</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    mq.<span class="ex">connect</span>()</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    mq.declare_exchange(<span class="st">&#39;events_exchange&#39;</span>, <span class="st">&#39;fanout&#39;</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    queue_name <span class="op">=</span> mq.declare_queue(<span class="st">&#39;notification_events_queue&#39;</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    mq.bind_queue(queue_name, <span class="st">&#39;events_exchange&#39;</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> asyncio</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        event <span class="op">=</span> json.loads(body)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="ss">f&quot;Received event: </span><span class="sc">{</span>event<span class="sc">.</span>get(<span class="st">&#39;type&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bridge from sync Pika thread to async Socket.IO</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        asyncio.run(sio.emit(<span class="st">&#39;order-update&#39;</span>, event.get(<span class="st">&#39;data&#39;</span>, {})))</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    mq.consume(queue_name, callback)</span></div></div>
<hr />
<h2 id="adapter-communication-patterns">6. Adapter Communication
Patterns</h2>
<h3 id="adapter-architecture">6.1 Adapter Architecture</h3>
<p>Each adapter follows the same pattern with protocol-specific
implementations:</p>
<div class="mermaid">graph TB
    subgraph &quot;Adapter Structure&quot;
        MQ[RabbitMQ Consumer&lt;br/&gt;Thread]
        PT[Protocol Translator]
        ES[External Service&lt;br/&gt;Client]
        PUB[RabbitMQ Publisher]
    end

    MQ --&gt;|JSON Message| PT
    PT --&gt;|Protocol-specific| ES
    ES --&gt;|Response| PT
    PT --&gt;|Event| PUB

    style MQ fill:#e1f5ff
    style PT fill:#fff3e0
    style ES fill:#f3e5f5
    style PUB fill:#e8f5e9</div>
<h3 id="cms-adapter-soap-protocol">6.2 CMS Adapter (SOAP Protocol)</h3>
<p><strong>Purpose:</strong> Validate customer information via legacy
SOAP service</p>
<p><strong>Implementation</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/adapters/cms-adapter/main.py">adapters/cms-adapter/main.py</a>):</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> consume_orders():</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    mq.<span class="ex">connect</span>()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    mq.declare_exchange(<span class="st">&#39;order_exchange&#39;</span>, <span class="st">&#39;fanout&#39;</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    queue_name <span class="op">=</span> mq.declare_queue(<span class="st">&#39;cms_order_queue&#39;</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    mq.bind_queue(queue_name, <span class="st">&#39;order_exchange&#39;</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>            order <span class="op">=</span> json.loads(body)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>            logger.info(<span class="ss">f&quot;Processing order: </span><span class="sc">{</span>order[<span class="st">&#39;orderId&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Transform JSON to SOAP and call CMS</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># In production: use zeep library for SOAP client</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            soap_response <span class="op">=</span> call_cms_soap_service(order)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Publish success event</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>            mq.publish(</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>                exchange_name<span class="op">=</span><span class="st">&#39;events_exchange&#39;</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>                message<span class="op">=</span>{</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;type&quot;</span>: <span class="st">&quot;cms.success&quot;</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;data&quot;</span>: {</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;orderId&quot;</span>: order[<span class="st">&#39;orderId&#39;</span>],</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;status&quot;</span>: <span class="st">&quot;CMS_VALIDATED&quot;</span>,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;message&quot;</span>: <span class="st">&quot;Customer validated successfully&quot;</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>            ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>            logger.error(<span class="ss">f&quot;Error processing order: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>            ch.basic_nack(delivery_tag<span class="op">=</span>method.delivery_tag, requeue<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    mq.consume(queue_name, callback)</span></div></div>
<p><strong>SOAP Message Example:</strong></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">soap:Envelope</span><span class="ot"> xmlns:soap=</span><span class="st">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">soap:Body</span>&gt;</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">ValidateCustomer</span><span class="ot"> xmlns=</span><span class="st">&quot;http://swiftlogistics.com/cms&quot;</span>&gt;</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">CustomerId</span>&gt;usr_12345&lt;/<span class="kw">CustomerId</span>&gt;</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">OrderId</span>&gt;ORD-20260204-ABC123&lt;/<span class="kw">OrderId</span>&gt;</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">ValidateCustomer</span>&gt;</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">soap:Body</span>&gt;</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">soap:Envelope</span>&gt;</span></div></div>
<h3 id="ros-adapter-rest-protocol">6.3 ROS Adapter (REST Protocol)</h3>
<p><strong>Purpose:</strong> Calculate optimal delivery route</p>
<p><strong>Implementation</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/adapters/ros-adapter/main.py">adapters/ros-adapter/main.py</a>):</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> json.loads(body)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="ss">f&quot;Processing order: </span><span class="sc">{</span>order[<span class="st">&#39;orderId&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Call ROS REST API</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">async</span> <span class="cf">with</span> httpx.AsyncClient() <span class="im">as</span> client:</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> <span class="cf">await</span> client.post(</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;</span><span class="sc">{</span>ROS_API_URL<span class="sc">}</span><span class="ss">/api/routes/optimize&quot;</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                json<span class="op">=</span>{</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;pickup&quot;</span>: order[<span class="st">&#39;pickupLocation&#39;</span>],</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;delivery&quot;</span>: order[<span class="st">&#39;deliveryAddress&#39;</span>]</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            route_data <span class="op">=</span> response.json()</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Publish success event</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>            mq.publish(</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>                exchange_name<span class="op">=</span><span class="st">&#39;events_exchange&#39;</span>,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>                message<span class="op">=</span>{</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;type&quot;</span>: <span class="st">&quot;ros.success&quot;</span>,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;data&quot;</span>: {</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;orderId&quot;</span>: order[<span class="st">&#39;orderId&#39;</span>],</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;route&quot;</span>: route_data[<span class="st">&#39;route&#39;</span>],</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;eta&quot;</span>: route_data[<span class="st">&#39;eta&#39;</span>],</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;distance&quot;</span>: route_data[<span class="st">&#39;distance&#39;</span>]</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f&quot;Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        ch.basic_nack(delivery_tag<span class="op">=</span>method.delivery_tag, requeue<span class="op">=</span><span class="va">True</span>)</span></div></div>
<p><strong>REST Request:</strong></p>
<pre class="http"><code>POST /api/routes/optimize HTTP/1.1
Host: ros-mock:3003
Content-Type: application/json

{
  &quot;pickup&quot;: {
    &quot;address&quot;: &quot;123 Main St&quot;,
    &quot;coordinates&quot;: {&quot;lat&quot;: 40.7128, &quot;lng&quot;: -74.0060}
  },
  &quot;delivery&quot;: {
    &quot;address&quot;: &quot;456 Oak Ave&quot;,
    &quot;coordinates&quot;: {&quot;lat&quot;: 40.7589, &quot;lng&quot;: -73.9851}
  }
}</div>
<h3 id="wms-adapter-tcp-socket-protocol">6.4 WMS Adapter (TCP Socket
Protocol)</h3>
<p><strong>Purpose:</strong> Reserve inventory in warehouse</p>
<p><strong>Implementation</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/adapters/wms-adapter/main.py">adapters/wms-adapter/main.py</a>):</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> json.loads(body)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="ss">f&quot;Processing order: </span><span class="sc">{</span>order[<span class="st">&#39;orderId&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open TCP socket to WMS</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="im">as</span> sock:</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>            sock.<span class="ex">connect</span>((WMS_HOST, WMS_PORT))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Send TCP message</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>            message <span class="op">=</span> <span class="ss">f&quot;RESERVE|</span><span class="sc">{</span>order[<span class="st">&#39;orderId&#39;</span>]<span class="sc">}</span><span class="ss">|</span><span class="sc">{</span>order[<span class="st">&#39;packageDetails&#39;</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>            sock.sendall(message.encode())</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Receive response</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> sock.recv(<span class="dv">1024</span>).decode()</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> response.startswith(<span class="st">&quot;ACK&quot;</span>):</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>                mq.publish(</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>                    exchange_name<span class="op">=</span><span class="st">&#39;events_exchange&#39;</span>,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                    message<span class="op">=</span>{</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;type&quot;</span>: <span class="st">&quot;wms.success&quot;</span>,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;data&quot;</span>: {</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;orderId&quot;</span>: order[<span class="st">&#39;orderId&#39;</span>],</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;inventory&quot;</span>: <span class="st">&quot;RESERVED&quot;</span>,</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;warehouse&quot;</span>: <span class="st">&quot;WH-001&quot;</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>        ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f&quot;Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>        ch.basic_nack(delivery_tag<span class="op">=</span>method.delivery_tag, requeue<span class="op">=</span><span class="va">True</span>)</span></div></div>
<p><strong>TCP Protocol:</strong></p>
<pre><code>Request:  RESERVE|ORD-20260204-ABC123|{&quot;weight&quot;:5,&quot;dimensions&quot;:&quot;30x20x10&quot;}\n
Response: ACK|WH-001|INVENTORY_RESERVED\n</div>
<h3 id="adapter-comparison-table">6.5 Adapter Comparison Table</h3>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 23%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>CMS Adapter</th>
<th>ROS Adapter</th>
<th>WMS Adapter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Protocol</strong></td>
<td>SOAP (XML)</td>
<td>REST (JSON)</td>
<td>TCP (Custom)</td>
</tr>
<tr class="even">
<td><strong>Library</strong></td>
<td>zeep</td>
<td>httpx</td>
<td>socket</td>
</tr>
<tr class="odd">
<td><strong>Port</strong></td>
<td>3001</td>
<td>3003</td>
<td>4002</td>
</tr>
<tr class="even">
<td><strong>Purpose</strong></td>
<td>Customer validation</td>
<td>Route optimization</td>
<td>Inventory management</td>
</tr>
<tr class="odd">
<td><strong>Request Format</strong></td>
<td>XML Envelope</td>
<td>HTTP POST JSON</td>
<td>TCP text protocol</td>
</tr>
<tr class="even">
<td><strong>Sync/Async</strong></td>
<td>Synchronous</td>
<td>Asynchronous</td>
<td>Synchronous</td>
</tr>
<tr class="odd">
<td><strong>Event Published</strong></td>
<td>cms.success</td>
<td>ros.success</td>
<td>wms.success</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="websocket-real-time-notifications">7. WebSocket Real-Time
Notifications</h2>
<h3 id="websocket-architecture">7.1 WebSocket Architecture</h3>
<div class="mermaid">sequenceDiagram
    participant U as User Browser
    participant NS as Notification Service&lt;br/&gt;(Socket.IO)
    participant MQ as RabbitMQ
    participant A as Adapter

    U-&gt;&gt;NS: Connect WebSocket&lt;br/&gt;socket.io handshake
    NS--&gt;&gt;U: Connection established&lt;br/&gt;sid: xyz123

    Note over A,MQ: Order processing completes
    A-&gt;&gt;MQ: Publish to&lt;br/&gt;events_exchange

    MQ-&gt;&gt;NS: Consume event from&lt;br/&gt;notification_events_queue

    Note over NS: Thread → Async bridge&lt;br/&gt;asyncio.run()

    NS-&gt;&gt;U: emit(&#39;order-update&#39;, {&lt;br/&gt;orderId, status, message&lt;br/&gt;})

    Note over U: React updates UI&lt;br/&gt;without refresh</div>
<h3 id="socket.io-server-setup">7.2 Socket.IO Server Setup</h3>
<p><strong>Server Configuration</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/notification-service/main.py#L18-L26">notification-service/main.py</a>):</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>sio <span class="op">=</span> socketio.AsyncServer(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    async_mode<span class="op">=</span><span class="st">&#39;asgi&#39;</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    cors_allowed_origins<span class="op">=</span>[</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;http://localhost:3000&quot;</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;http://localhost:5173&quot;</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        os.getenv(<span class="st">&quot;WEB_CLIENT_URL&quot;</span>, <span class="st">&quot;*&quot;</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrap FastAPI with Socket.IO</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>socket_app <span class="op">=</span> socketio.ASGIApp(sio, app)</span></div></div>
<h3 id="event-handlers">7.3 Event Handlers</h3>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="at">@sio.event</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> <span class="ex">connect</span>(sid, environ):</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handle client connection.&quot;&quot;&quot;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f&quot;Client connected: </span><span class="sc">{</span>sid<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sid is unique socket ID for this client</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="at">@sio.event</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> disconnect(sid):</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handle client disconnection.&quot;&quot;&quot;</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f&quot;Client disconnected: </span><span class="sc">{</span>sid<span class="sc">}</span><span class="ss">&quot;</span>)</span></div></div>
<h3 id="broadcasting-events">7.4 Broadcasting Events</h3>
<p><strong>From RabbitMQ to WebSocket:</strong></p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    event <span class="op">=</span> json.loads(body)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f&quot;Received event: </span><span class="sc">{</span>event<span class="sc">.</span>get(<span class="st">&#39;type&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bridge blocking Pika thread to async Socket.IO</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    asyncio.run(sio.emit(<span class="st">&#39;order-update&#39;</span>, event.get(<span class="st">&#39;data&#39;</span>, {})))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span></div></div>
<h3 id="frontend-websocket-client">7.5 Frontend WebSocket Client</h3>
<p><strong>React Implementation:</strong></p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { io } <span class="im">from</span> <span class="st">&quot;socket.io-client&quot;</span><span class="op">;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Connect to notification service</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> socket <span class="op">=</span> <span class="fu">io</span>(<span class="st">&quot;http://localhost:3002&quot;</span>)<span class="op">;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for order updates</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>socket<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;order-update&quot;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Order update:&quot;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update UI: {orderId, status, message}</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateOrderUI</span>(data)<span class="op">;</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Connection events</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>socket<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;connect&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;WebSocket connected&quot;</span>)<span class="op">;</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>socket<span class="op">.</span><span class="fu">on</span>(<span class="st">&quot;disconnect&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;WebSocket disconnected&quot;</span>)<span class="op">;</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></div></div>
<h3 id="thread-to-async-bridge">7.6 Thread-to-Async Bridge</h3>
<p><strong>Challenge:</strong> Pika runs in a blocking thread, Socket.IO
is async</p>
<p><strong>Solution:</strong></p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 1: asyncio.run() creates new event loop</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>asyncio.run(sio.emit(<span class="st">&#39;order-update&#39;</span>, data))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 2: run_coroutine_threadsafe() uses existing loop</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>loop <span class="op">=</span> asyncio.get_event_loop()</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>asyncio.run_coroutine_threadsafe(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    sio.emit(<span class="st">&#39;order-update&#39;</span>, data),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    loop</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>)</span></div></div>
<hr />
<h2 id="message-payload-specifications">8. Message Payload
Specifications</h2>
<h3 id="order-creation-request">8.1 Order Creation Request</h3>
<p><strong>HTTP Request:</strong></p>
<pre class="http"><code>POST /api/orders HTTP/1.1
Host: api-gateway:3000
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  &quot;customerId&quot;: &quot;usr_12345&quot;,
  &quot;pickupLocation&quot;: {
    &quot;address&quot;: &quot;123 Main Street, New York, NY 10001&quot;,
    &quot;coordinates&quot;: {
      &quot;lat&quot;: 40.7128,
      &quot;lng&quot;: -74.0060
    }
  },
  &quot;deliveryAddress&quot;: {
    &quot;address&quot;: &quot;456 Oak Avenue, Brooklyn, NY 11201&quot;,
    &quot;coordinates&quot;: {
      &quot;lat&quot;: 40.6782,
      &quot;lng&quot;: -73.9442
    }
  },
  &quot;packageDetails&quot;: {
    &quot;weight&quot;: 5.5,
    &quot;dimensions&quot;: &quot;30x20x10&quot;,
    &quot;description&quot;: &quot;Electronics&quot;,
    &quot;fragile&quot;: true
  },
  &quot;scheduledPickupTime&quot;: &quot;2026-02-05T09:00:00Z&quot;,
  &quot;specialInstructions&quot;: &quot;Handle with care, ring doorbell&quot;
}</div>
<h3 id="rabbitmq-message-order_exchange">8.2 RabbitMQ Message:
order_exchange</h3>
<p><strong>Published by:</strong> Orchestrator<br />
<strong>Consumed by:</strong> CMS Adapter, ROS Adapter, WMS Adapter</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;customerId&quot;</span><span class="fu">:</span> <span class="st">&quot;usr_12345&quot;</span><span class="fu">,</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pickupLocation&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;address&quot;</span><span class="fu">:</span> <span class="st">&quot;123 Main Street, New York, NY 10001&quot;</span><span class="fu">,</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;coordinates&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;lat&quot;</span><span class="fu">:</span> <span class="fl">40.7128</span><span class="fu">,</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;lng&quot;</span><span class="fu">:</span> <span class="fl">-74.006</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;deliveryAddress&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;address&quot;</span><span class="fu">:</span> <span class="st">&quot;456 Oak Avenue, Brooklyn, NY 11201&quot;</span><span class="fu">,</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;coordinates&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;lat&quot;</span><span class="fu">:</span> <span class="fl">40.6782</span><span class="fu">,</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;lng&quot;</span><span class="fu">:</span> <span class="fl">-73.9442</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;packageDetails&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;weight&quot;</span><span class="fu">:</span> <span class="fl">5.5</span><span class="fu">,</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;dimensions&quot;</span><span class="fu">:</span> <span class="st">&quot;30x20x10&quot;</span><span class="fu">,</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Electronics&quot;</span><span class="fu">,</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;fragile&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:30.123456Z&quot;</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<h3 id="rabbitmq-message-events_exchange">8.3 RabbitMQ Message:
events_exchange</h3>
<p><strong>Published by:</strong> Orchestrator, Adapters<br />
<strong>Consumed by:</strong> Notification Service</p>
<p><strong>ORDER_CREATED Event:</strong></p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;ORDER_CREATED&quot;</span><span class="fu">,</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;RECEIVED&quot;</span><span class="fu">,</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Order received and being processed&quot;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:30.123456Z&quot;</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<p><strong>cms.success Event:</strong></p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;cms.success&quot;</span><span class="fu">,</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;CMS_VALIDATED&quot;</span><span class="fu">,</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer validated successfully&quot;</span><span class="fu">,</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;customerData&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;usr_12345&quot;</span><span class="fu">,</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;John Doe&quot;</span><span class="fu">,</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;tier&quot;</span><span class="fu">:</span> <span class="st">&quot;premium&quot;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:32.456789Z&quot;</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<p><strong>ros.success Event:</strong></p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;ros.success&quot;</span><span class="fu">,</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;route&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;waypoints&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;lat&quot;</span><span class="fu">:</span> <span class="fl">40.7128</span><span class="fu">,</span> <span class="dt">&quot;lng&quot;</span><span class="fu">:</span> <span class="fl">-74.006</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;lat&quot;</span><span class="fu">:</span> <span class="fl">40.75</span><span class="fu">,</span> <span class="dt">&quot;lng&quot;</span><span class="fu">:</span> <span class="fl">-73.99</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span> <span class="dt">&quot;lat&quot;</span><span class="fu">:</span> <span class="fl">40.6782</span><span class="fu">,</span> <span class="dt">&quot;lng&quot;</span><span class="fu">:</span> <span class="fl">-73.9442</span> <span class="fu">}</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;distance&quot;</span><span class="fu">:</span> <span class="fl">12.3</span><span class="fu">,</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;eta&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-05T10:45:00Z&quot;</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Route optimized successfully&quot;</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:35.789012Z&quot;</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<p><strong>wms.success Event:</strong></p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;wms.success&quot;</span><span class="fu">,</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;inventory&quot;</span><span class="fu">:</span> <span class="st">&quot;RESERVED&quot;</span><span class="fu">,</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;warehouse&quot;</span><span class="fu">:</span> <span class="st">&quot;WH-001&quot;</span><span class="fu">,</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;pickingLocation&quot;</span><span class="fu">:</span> <span class="st">&quot;A-12-05&quot;</span><span class="fu">,</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Inventory reserved successfully&quot;</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:33.234567Z&quot;</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<h3 id="websocket-message-order-update">8.4 WebSocket Message:
order-update</h3>
<p><strong>Emitted by:</strong> Notification Service<br />
<strong>Received by:</strong> Frontend (React/React Native)</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;CMS_VALIDATED&quot;</span><span class="fu">,</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Customer validated successfully&quot;</span><span class="fu">,</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;customerData&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;usr_12345&quot;</span><span class="fu">,</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;John Doe&quot;</span><span class="fu">,</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;tier&quot;</span><span class="fu">:</span> <span class="st">&quot;premium&quot;</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<h3 id="jwt-token-payload">8.5 JWT Token Payload</h3>
<p><strong>Encoded Token:</strong></p>
<pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ1c3JfMTIzNDUiLCJlbWFpbCI6ImpvaG5AZXhhbXBsZS5jb20iLCJyb2xlIjoiY2xpZW50IiwiZXhwIjoxNzA3MTc4ODY4fQ.signature</div>
<p><strong>Decoded Payload:</strong></p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;userId&quot;</span><span class="fu">:</span> <span class="st">&quot;usr_12345&quot;</span><span class="fu">,</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;john@example.com&quot;</span><span class="fu">,</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;role&quot;</span><span class="fu">:</span> <span class="st">&quot;client&quot;</span><span class="fu">,</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;exp&quot;</span><span class="fu">:</span> <span class="dv">1707178868</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<h3 id="http-response-order-created">8.6 HTTP Response: Order
Created</h3>
<p><strong>Status:</strong> 202 Accepted</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;orderId&quot;</span><span class="fu">:</span> <span class="st">&quot;ORD-20260204-ABC123&quot;</span><span class="fu">,</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;RECEIVED&quot;</span><span class="fu">,</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Order received and being processed&quot;</span><span class="fu">,</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;customerId&quot;</span><span class="fu">:</span> <span class="st">&quot;usr_12345&quot;</span><span class="fu">,</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2026-02-04T16:20:30.123456Z&quot;</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<hr />
<h2 id="thread-safety-and-concurrency-deep-dive">9. Thread Safety and
Concurrency Deep Dive</h2>
<h3 id="python-global-interpreter-lock-gil">9.1 Python Global
Interpreter Lock (GIL)</h3>
<p>The <strong>GIL</strong> is a mutex that protects access to Python
objects, preventing multiple native threads from executing Python
bytecodes simultaneously. This has critical implications for the
SwiftLogistics system.</p>
<p><strong>What the GIL Does:</strong></p>
<div class="mermaid">graph LR
    T1[Thread 1&lt;br/&gt;FastAPI Handler]
    T2[Thread 2&lt;br/&gt;Pika Consumer]
    GIL[Global&lt;br/&gt;Interpreter&lt;br/&gt;Lock]

    T1 -.-&gt;|Wait for GIL| GIL
    T2 --&gt;|Has GIL| GIL

    style GIL fill:#ff6b6b
    style T1 fill:#e0e0e0
    style T2 fill:#4ecdc4</div>
<p><strong>Key Characteristics:</strong></p>
<ol type="1">
<li><strong>Only ONE thread executes Python code at a time</strong></li>
<li><strong>I/O operations release the GIL</strong> (network calls, file
I/O)</li>
<li><strong>CPU-bound tasks don’t benefit from threading</strong> (but
we don’t have many CPU-bound tasks)</li>
<li><strong>Simplifies thread safety</strong> for Python object
access</li>
</ol>
<p><strong>Example in SwiftLogistics:</strong></p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Thread 1: FastAPI handling HTTP request (async)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> create_order(order_request):</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># When awaiting I/O, yields control and releases GIL</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> order.insert()  <span class="co"># MongoDB I/O - GIL released</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other threads can execute Python code during this wait</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Thread 2: Pika consumer (blocking)</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> json.loads(body)  <span class="co"># Has GIL</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># When calling external HTTP API, GIL is released</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.post(CMS_API_URL, data<span class="op">=</span>order)  <span class="co"># I/O - GIL released</span></span></div></div>
<h3 id="thread-safety-mechanisms">9.2 Thread Safety Mechanisms</h3>
<h4 id="thread-isolation">9.2.1 Thread Isolation</h4>
<p>Each service uses <strong>complete thread isolation</strong> to avoid
race conditions:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ❌ UNSAFE: Sharing mutable state between threads</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>shared_orders <span class="op">=</span> {}  <span class="co"># Global dictionary</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread1_handler():</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    shared_orders[<span class="st">&#39;ORD-123&#39;</span>] <span class="op">=</span> <span class="st">&#39;PROCESSING&#39;</span>  <span class="co"># Race condition!</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread2_handler():</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;ORD-123&#39;</span> <span class="kw">in</span> shared_orders:  <span class="co"># Race condition!</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        process(shared_orders[<span class="st">&#39;ORD-123&#39;</span>])</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ SAFE: SwiftLogistics approach - No shared state</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread1_handler():</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Each thread has its own connection</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> order.insert()  <span class="co"># Stored in MongoDB</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread2_handler():</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reads from database, not shared memory</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> <span class="cf">await</span> Order.find_one(Order.orderId <span class="op">==</span> <span class="st">&#39;ORD-123&#39;</span>)</span></div></div>
<p><strong>Thread Isolation Strategies:</strong></p>
<table>
<thead>
<tr class="header">
<th>Component</th>
<th>Isolation Method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>FastAPI</strong></td>
<td>Each request runs in async task, not thread</td>
</tr>
<tr class="even">
<td><strong>Pika Consumer</strong></td>
<td>Dedicated daemon thread, owns its connection</td>
</tr>
<tr class="odd">
<td><strong>MongoDB</strong></td>
<td>Motor async driver, connection pool per process</td>
</tr>
<tr class="even">
<td><strong>RabbitMQ</strong></td>
<td>Separate BlockingConnection per thread</td>
</tr>
</tbody>
</table>
<h4 id="connection-management">9.2.2 Connection Management</h4>
<p><strong>MongoDB Connection Pool</strong> (Thread-Safe via Motor):</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database:</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Class-level singleton client (shared across async tasks, not threads)</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    client: Optional[AsyncIOMotorClient] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> connect_db(cls, document_models: <span class="bu">list</span>):</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create ONE client per process</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        cls.client <span class="op">=</span> AsyncIOMotorClient(mongodb_uri)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Motor internally manages connection pool</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># - Pool size: default 100</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># - Thread-safe: Yes</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># - Multiple async tasks share pool safely</span></span></div></div>
<p><strong>How Motor Connection Pool Works:</strong></p>
<div class="mermaid">graph TB
    subgraph &quot;Orchestrator Process&quot;
        T1[Async Task 1&lt;br/&gt;POST /orders]
        T2[Async Task 2&lt;br/&gt;POST /orders]
        T3[Async Task 3&lt;br/&gt;GET /orders/123]

        Pool[Motor Connection Pool&lt;br/&gt;Size: 100&lt;br/&gt;Thread-Safe: Yes]

        T1 --&gt;|Checkout| Pool
        T2 --&gt;|Checkout| Pool
        T3 --&gt;|Checkout| Pool
    end

    Pool --&gt;|TCP| MongoDB[MongoDB Server]

    style Pool fill:#4ecdc4</div>
<p><strong>Key Features:</strong></p>
<ul>
<li><strong>Automatic checkout/checkin</strong> when async operations
complete</li>
<li><strong>Thread-safe</strong> via internal locks</li>
<li><strong>No manual management</strong> required</li>
</ul>
<p><strong>RabbitMQ Connection Per Thread</strong> (Explicit
Isolation):</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Each adapter creates its own connection in its thread</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> consume_orders():</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Thread 1: CMS Adapter</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    mq <span class="op">=</span> MessageQueue()  <span class="co"># New instance</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    mq.<span class="ex">connect</span>()  <span class="co"># Dedicated BlockingConnection</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.connection <span class="op">=</span> pika.BlockingConnection(params)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.channel <span class="op">=</span> <span class="va">self</span>.connection.channel()</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This connection is ONLY used by this thread</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    mq.consume(queue_name, callback)</span></div></div>
<p><strong>Why Not Share Pika Connections?</strong></p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ❌ UNSAFE: Sharing Pika channel between threads</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>channel <span class="op">=</span> connection.channel()  <span class="co"># Single channel</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread1():</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    channel.basic_publish(...)  <span class="co"># ⚠️ Race condition!</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread2():</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    channel.basic_publish(...)  <span class="co"># ⚠️ Race condition!</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ SAFE: Each thread owns its connection</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread1():</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    mq1 <span class="op">=</span> MessageQueue()</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    mq1.<span class="ex">connect</span>()  <span class="co"># Own connection</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    mq1.channel.basic_publish(...)</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> thread2():</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    mq2 <span class="op">=</span> MessageQueue()</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    mq2.<span class="ex">connect</span>()  <span class="co"># Own connection</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    mq2.channel.basic_publish(...)</span></div></div>
<h4 id="daemon-threads">9.2.3 Daemon Threads</h4>
<p>All background consumer threads are <strong>daemon
threads</strong>:</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>consumer_thread <span class="op">=</span> threading.Thread(target<span class="op">=</span>consume_orders, daemon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>consumer_thread.start()</span></div></div>
<p><strong>What <code>daemon=True</code> Means:</strong></p>
<div class="mermaid">graph LR
    Main[Main Thread&lt;br/&gt;FastAPI Server]
    Daemon[Daemon Thread&lt;br/&gt;Pika Consumer]

    Main --&gt;|Exits| Exit[Process Terminates]
    Daemon -.-&gt;|Forced to exit| Exit

    style Main fill:#4ecdc4
    style Daemon fill:#ffe66d
    style Exit fill:#ff6b6b</div>
<p><strong>Daemon Thread Characteristics:</strong></p>
<ol type="1">
<li><strong>Non-blocking termination:</strong> Process can exit even if
daemon threads are running</li>
<li><strong>No graceful shutdown:</strong> Daemon thread is killed when
main thread exits</li>
<li><strong>Use case:</strong> Background tasks that don’t need cleanup
(our consumers ACK messages, so no data loss)</li>
</ol>
<p><strong>Regular Thread vs Daemon Thread:</strong></p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regular thread (daemon=False, default)</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>regular_thread <span class="op">=</span> threading.Thread(target<span class="op">=</span>important_task)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>regular_thread.start()</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Process waits for this thread to finish before exiting</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Daemon thread (daemon=True)</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>daemon_thread <span class="op">=</span> threading.Thread(target<span class="op">=</span>background_task, daemon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>daemon_thread.start()</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Process exits immediately, killing this thread</span></span></div></div>
<h4 id="thread-to-async-bridge-1">9.2.4 Thread-to-Async Bridge</h4>
<p>The Notification Service bridges <strong>synchronous Pika
callbacks</strong> to <strong>async Socket.IO</strong>:</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Running in: Pika consumer thread (synchronous)</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    event <span class="op">=</span> json.loads(body)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Problem: sio.emit() is async, but we&#39;re in sync context</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solution: Create new event loop</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    asyncio.run(sio.emit(<span class="st">&#39;order-update&#39;</span>, event.get(<span class="st">&#39;data&#39;</span>, {})))</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span></div></div>
<p><strong>How <code>asyncio.run()</code> Works:</strong></p>
<div class="mermaid">sequenceDiagram
    participant PT as Pika Thread&lt;br/&gt;(Blocking)
    participant Loop as New Event&lt;br/&gt;Loop
    participant SIO as Socket.IO&lt;br/&gt;(Async)

    PT-&gt;&gt;PT: Receive message
    PT-&gt;&gt;Loop: asyncio.run(emit())
    Note over Loop: Create new&lt;br/&gt;event loop
    Loop-&gt;&gt;SIO: await emit()
    SIO--&gt;&gt;Loop: Complete
    Loop--&gt;&gt;PT: Return
    PT-&gt;&gt;PT: ACK message</div>
<p><strong>Alternative:
<code>run_coroutine_threadsafe()</code>:</strong></p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If FastAPI event loop is running</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>loop <span class="op">=</span> asyncio.get_event_loop()</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    event <span class="op">=</span> json.loads(body)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Schedule coroutine in existing loop</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    future <span class="op">=</span> asyncio.run_coroutine_threadsafe(</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        sio.emit(<span class="st">&#39;order-update&#39;</span>, event.get(<span class="st">&#39;data&#39;</span>, {})),</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        loop</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally wait for result</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># future.result(timeout=5)</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span></div></div>
<h3 id="concurrency-model-summary">9.3 Concurrency Model Summary</h3>
<p><strong>SwiftLogistics uses a hybrid concurrency model:</strong></p>
<div class="mermaid">graph TB
    subgraph &quot;Main Event Loop - asyncio&quot;
        FastAPI[FastAPI HTTP Handlers&lt;br/&gt;async/await]
        MongoDB[MongoDB Operations&lt;br/&gt;Motor async]
        HTTP[HTTP Clients&lt;br/&gt;httpx async]
    end

    subgraph &quot;Worker Threads - Blocking I/O&quot;
        Pika1[CMS Adapter&lt;br/&gt;Pika Consumer]
        Pika2[ROS Adapter&lt;br/&gt;Pika Consumer]
        Pika3[WMS Adapter&lt;br/&gt;Pika Consumer]
        Pika4[Notification&lt;br/&gt;Pika Consumer]
    end

    FastAPI -.-&gt;|async tasks| MongoDB
    FastAPI -.-&gt;|async tasks| HTTP

    Pika1 -.-&gt;|Bridge| FastAPI
    Pika2 -.-&gt;|Bridge| FastAPI
    Pika3 -.-&gt;|Bridge| FastAPI
    Pika4 -.-&gt;|Bridge| FastAPI

    style FastAPI fill:#4ecdc4
    style Pika1 fill:#ffe66d
    style Pika2 fill:#ffe66d
    style Pika3 fill:#ffe66d
    style Pika4 fill:#ffe66d</div>
<p><strong>Benefits of This Model:</strong></p>
<ol type="1">
<li><strong>AsyncIO for HTTP:</strong> High throughput for API
requests</li>
<li><strong>Threads for Pika:</strong> Compatible with blocking Pika
library</li>
<li><strong>GIL doesn’t hurt:</strong> Most time spent in I/O (GIL
released)</li>
<li><strong>No shared state:</strong> Each layer isolated via
database/message queue</li>
</ol>
<hr />
<h2 id="complete-design-patterns-catalog">10. Complete Design Patterns
Catalog</h2>
<h3 id="architectural-patterns">10.1 Architectural Patterns</h3>
<h4 id="microservices-architecture">10.1.1 Microservices
Architecture</h4>
<p>The system is decomposed into independent services:</p>
<pre><code>api-gateway → Authentication, routing
orchestrator → Business logic, state machine
notification-service → Real-time push
cms-adapter → Protocol translation
ros-adapter → Protocol translation
wms-adapter → Protocol translation</div>
<p><strong>Characteristics:</strong></p>
<ul>
<li>✅ Independent deployment</li>
<li>✅ Single responsibility</li>
<li>✅ Communication via message queue</li>
<li>✅ Polyglot persistence (if needed)</li>
</ul>
<h4 id="event-driven-architecture-eda">10.1.2 Event-Driven Architecture
(EDA)</h4>
<p>Events trigger actions asynchronously:</p>
<div class="mermaid">graph LR
    Producer[Order Created]
    Broker[RabbitMQ]
    Consumer1[CMS Adapter]
    Consumer2[ROS Adapter]
    Consumer3[WMS Adapter]

    Producer --&gt;|Event| Broker
    Broker --&gt;|Subscribe| Consumer1
    Broker --&gt;|Subscribe| Consumer2
    Broker --&gt;|Subscribe| Consumer3</div>
<p><strong>Benefits:</strong></p>
<ul>
<li>Loose coupling</li>
<li>Scalability (add more consumers)</li>
<li>Resilience (failures isolated)</li>
</ul>
<h4 id="api-gateway-pattern">10.1.3 API Gateway Pattern</h4>
<p>Single entry point for all client requests:</p>
<pre><code>Frontend → API Gateway → [Orchestrator, CMS Mock, ...]</div>
<p><strong>Responsibilities:</strong></p>
<ul>
<li>Authentication (JWT)</li>
<li>Rate limiting</li>
<li>Request routing</li>
<li>CORS handling</li>
</ul>
<h4 id="orchestration-pattern-saga-like">10.1.4 Orchestration Pattern
(Saga-like)</h4>
<p>Orchestrator manages distributed transaction flow:</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Orchestrator coordinates but doesn&#39;t wait</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> Save order to DB</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> Publish to RabbitMQ</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span> Return <span class="dv">202</span> Accepted</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Adapters work independently</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="fl">4.</span> CMS processes → publishes event</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="fl">5.</span> ROS processes → publishes event</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="fl">6.</span> WMS processes → publishes event</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Eventual consistency achieved via events</span></span></div></div>
<h3 id="structural-design-patterns">10.2 Structural Design Patterns</h3>
<h4 id="adapter-pattern">10.2.1 Adapter Pattern</h4>
<p><strong>Purpose:</strong> Convert one interface to another</p>
<p><strong>Implementation:</strong> Protocol adapters translate RabbitMQ
JSON to SOAP/REST/TCP</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CMSAdapter:</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_order(<span class="va">self</span>, json_order):</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adapt JSON to SOAP</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>        soap_request <span class="op">=</span> <span class="va">self</span>.json_to_soap(json_order)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.call_cms(soap_request)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adapt SOAP response back to JSON event</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.soap_to_json(response)</span></div></div>
<p><strong>Before Adapter:</strong></p>
<pre><code>Orchestrator (JSON) → ❌ CMS (SOAP) - Incompatible!</div>
<p><strong>After Adapter:</strong></p>
<pre><code>Orchestrator (JSON) → Adapter → SOAP → CMS
CMS → SOAP → Adapter → JSON → Events</div>
<h4 id="façade-pattern">10.2.2 Façade Pattern</h4>
<p><strong>Purpose:</strong> Simplified interface to complex
subsystem</p>
<p><strong>Implementation:</strong> <code>MessageQueue</code> class
wraps Pika complexity</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Complex Pika API</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> pika.URLParameters(url)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>params.heartbeat <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>connection <span class="op">=</span> pika.BlockingConnection(params)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>channel <span class="op">=</span> connection.channel()</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>channel.exchange_declare(exchange<span class="op">=</span><span class="st">&#39;x&#39;</span>, exchange_type<span class="op">=</span><span class="st">&#39;fanout&#39;</span>, durable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>channel.queue_declare(queue<span class="op">=</span><span class="st">&#39;q&#39;</span>, durable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>channel.queue_bind(queue<span class="op">=</span><span class="st">&#39;q&#39;</span>, exchange<span class="op">=</span><span class="st">&#39;x&#39;</span>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>channel.basic_publish(exchange<span class="op">=</span><span class="st">&#39;x&#39;</span>, routing_key<span class="op">=</span><span class="st">&#39;&#39;</span>, body<span class="op">=</span>json.dumps(msg))</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple Façade</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>mq <span class="op">=</span> MessageQueue()</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>mq.<span class="ex">connect</span>()</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>mq.declare_exchange(<span class="st">&#39;x&#39;</span>, <span class="st">&#39;fanout&#39;</span>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>mq.declare_queue(<span class="st">&#39;q&#39;</span>)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>mq.bind_queue(<span class="st">&#39;q&#39;</span>, <span class="st">&#39;x&#39;</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>mq.publish(<span class="st">&#39;x&#39;</span>, msg)</span></div></div>
<h4 id="repository-pattern">10.2.3 Repository Pattern</h4>
<p><strong>Purpose:</strong> Abstraction over data access</p>
<p><strong>Implementation:</strong> Beanie ODM provides repository-like
interface</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead of raw MongoDB queries</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>db.orders.find_one({<span class="st">&#39;orderId&#39;</span>: <span class="st">&#39;ORD-123&#39;</span>})</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use repository pattern via Beanie</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> <span class="cf">await</span> Order.find_one(Order.orderId <span class="op">==</span> <span class="st">&#39;ORD-123&#39;</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> order.save()</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> order.delete()</span></div></div>
<p><strong>Benefits:</strong></p>
<ul>
<li>Type safety</li>
<li>Query builder</li>
<li>No SQL injection</li>
<li>Easy to mock for testing</li>
</ul>
<h3 id="behavioral-design-patterns">10.3 Behavioral Design Patterns</h3>
<h4 id="observer-pattern-pubsub">10.3.1 Observer Pattern (Pub/Sub)</h4>
<p><strong>Purpose:</strong> One-to-many dependency where state change
notifies observers</p>
<p><strong>Implementation:</strong> RabbitMQ fanout exchange</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subject (Publisher)</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>orchestrator.publish(exchange<span class="op">=</span><span class="st">&#39;order_exchange&#39;</span>, message<span class="op">=</span>order)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Observers (Subscribers)</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>cms_adapter.subscribe(queue<span class="op">=</span><span class="st">&#39;cms_order_queue&#39;</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>ros_adapter.subscribe(queue<span class="op">=</span><span class="st">&#39;ros_order_queue&#39;</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>wms_adapter.subscribe(queue<span class="op">=</span><span class="st">&#39;wms_order_queue&#39;</span>)</span></div></div>
<p><strong>Diagram:</strong></p>
<div class="mermaid">graph TB
    Subject[Order Exchange&lt;br/&gt;Subject]
    Observer1[CMS Observer]
    Observer2[ROS Observer]
    Observer3[WMS Observer]

    Subject -.-&gt;|Notify| Observer1
    Subject -.-&gt;|Notify| Observer2
    Subject -.-&gt;|Notify| Observer3</div>
<h4 id="strategy-pattern">10.3.2 Strategy Pattern</h4>
<p><strong>Purpose:</strong> Define family of algorithms, make them
interchangeable</p>
<p><strong>Implementation:</strong> Protocol adapters implement same
interface with different strategies</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProtocolAdapter(ABC):</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_order(<span class="va">self</span>, order):</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SOAPAdapter(ProtocolAdapter):</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_order(<span class="va">self</span>, order):</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SOAP strategy</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RESTAdapter(ProtocolAdapter):</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_order(<span class="va">self</span>, order):</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># REST strategy</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TCPAdapter(ProtocolAdapter):</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_order(<span class="va">self</span>, order):</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># TCP strategy</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></div></div>
<h4 id="middlewarechain-of-responsibility-pattern">10.3.3
Middleware/Chain of Responsibility Pattern</h4>
<p><strong>Purpose:</strong> Pass request through chain of handlers</p>
<p><strong>Implementation:</strong> FastAPI middleware stack</p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>Request</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  ↓</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>[CORS Middleware]</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  ↓</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>[Rate Limiter]</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  ↓</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>[JWT Authentication]</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  ↓</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>[Request Handler]</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  ↓</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>Response</span></div></div>
<p><strong>Code:</strong></p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Each middleware can process or pass to next</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="at">@app.middleware</span>(<span class="st">&quot;http&quot;</span>)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> cors_middleware(request, call_next):</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> <span class="cf">await</span> call_next(request)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    response.headers[<span class="st">&quot;Access-Control-Allow-Origin&quot;</span>] <span class="op">=</span> <span class="st">&quot;*&quot;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="at">@app.middleware</span>(<span class="st">&quot;http&quot;</span>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> auth_middleware(request, call_next):</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.url.path.startswith(<span class="st">&quot;/api/&quot;</span>):</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verify JWT</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>        verify_token(request.headers.get(<span class="st">&quot;Authorization&quot;</span>))</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> <span class="cf">await</span> call_next(request)</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span></div></div>
<h4 id="template-method-pattern">10.3.4 Template Method Pattern</h4>
<p><strong>Purpose:</strong> Define skeleton of algorithm, subclasses
fill in steps</p>
<p><strong>Implementation:</strong> Adapter base structure</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Template method in base class</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BaseAdapter:</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_message(<span class="va">self</span>, message):</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 1: Always parse JSON</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> <span class="va">self</span>.parse_message(message)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 2: Transform (subclass implements)</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>        transformed <span class="op">=</span> <span class="va">self</span>.transform(data)</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 3: Send (subclass implements)</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.send_to_external(transformed)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 4: Always publish result</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.publish_result(response)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, data):</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_to_external(<span class="va">self</span>, data):</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Concrete implementation</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CMSAdapter(BaseAdapter):</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, data):</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json_to_soap(data)</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_to_external(<span class="va">self</span>, soap_data):</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> call_cms_soap(soap_data)</span></div></div>
<h3 id="creational-design-patterns">10.4 Creational Design Patterns</h3>
<h4 id="singleton-pattern">10.4.1 Singleton Pattern</h4>
<p><strong>Purpose:</strong> Ensure only one instance exists</p>
<p><strong>Implementation:</strong> Database connection, RabbitMQ
connection</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database:</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    client: Optional[AsyncIOMotorClient] <span class="op">=</span> <span class="va">None</span>  <span class="co"># Class variable (singleton)</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> connect_db(cls, document_models):</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cls.client <span class="kw">is</span> <span class="va">None</span>:  <span class="co"># Only create once</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>            cls.client <span class="op">=</span> AsyncIOMotorClient(mongodb_uri)</span></div></div>
<p><strong>Why Singleton?</strong></p>
<ul>
<li><strong>Database:</strong> Share connection pool across all
requests</li>
<li><strong>RabbitMQ:</strong> Expensive to create connections, reuse
per thread</li>
</ul>
<h4 id="factory-pattern">10.4.2 Factory Pattern</h4>
<p><strong>Purpose:</strong> Create objects without specifying exact
class</p>
<p><strong>Implementation:</strong> Order ID generation</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_order_id() <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Factory method for creating unique order IDs.&quot;&quot;&quot;</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> <span class="bu">int</span>(datetime.utcnow().timestamp())</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    random_suffix <span class="op">=</span> <span class="st">&#39;&#39;</span>.join(random.choices(string.ascii_lowercase <span class="op">+</span> string.digits, k<span class="op">=</span><span class="dv">6</span>))</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f&quot;ORD-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>random_suffix<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage - don&#39;t care about implementation details</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>order_id <span class="op">=</span> create_order_id()  <span class="co"># Factory creates it</span></span></div></div>
<h3 id="concurrency-patterns">10.5 Concurrency Patterns</h3>
<h4 id="active-object-pattern">10.5.1 Active Object Pattern</h4>
<p><strong>Purpose:</strong> Decouple method execution from
invocation</p>
<p><strong>Implementation:</strong> RabbitMQ message queue</p>
<pre><code>Client calls → Returns immediately (202 Accepted)
Background → Processes asynchronously
Client notified → Via WebSocket when done</div>
<h4 id="half-synchalf-async-pattern">10.5.2 Half-Sync/Half-Async
Pattern</h4>
<p><strong>Purpose:</strong> Separate sync and async processing
layers</p>
<p><strong>Implementation:</strong> FastAPI (async) + Pika (sync
threads)</p>
<pre><code>Async Layer: FastAPI HTTP handlers
Queue: RabbitMQ
Sync Layer: Pika consumer threads</div>
<h4 id="producer-consumer-pattern">10.5.3 Producer-Consumer Pattern</h4>
<p><strong>Purpose:</strong> Producers create work, consumers process
it</p>
<p><strong>Implementation:</strong> Order processing pipeline</p>
<pre><code>Producer: Orchestrator creates orders
Queue: RabbitMQ
Consumers: CMS/ROS/WMS adapters process orders</div>
<h3 id="reliability-patterns">10.6 Reliability Patterns</h3>
<h4 id="retry-pattern-via-rabbitmq-requeue">10.6.1 Retry Pattern (via
RabbitMQ Requeue)</h4>
<p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>        process_order(body)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)  <span class="co"># Success</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f&quot;Failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        ch.basic_nack(delivery_tag<span class="op">=</span>method.delivery_tag, requeue<span class="op">=</span><span class="va">True</span>)  <span class="co"># Retry</span></span></div></div>
<p><strong>Requeue Flow:</strong></p>
<pre><code>1. Message delivered to consumer
2. Processing fails
3. NACK with requeue=True
4. Message returned to queue
5. Delivered to consumer again (retry)</div>
<h4 id="idempotency-pattern">10.6.2 Idempotency Pattern</h4>
<p><strong>Purpose:</strong> Same operation can be applied multiple
times safely</p>
<p><strong>Implementation:</strong> Order ID uniqueness</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Even if message redelivered, won&#39;t create duplicate</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>order_id <span class="op">=</span> create_order_id()  <span class="co"># Unique timestamp-based ID</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> order.insert()  <span class="co"># MongoDB unique index on orderId</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> DuplicateKeyError:</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;Order already exists, skipping&quot;</span>)</span></div></div>
<h4 id="circuit-breaker-pattern-implicit-via-timeouts">10.6.3 Circuit
Breaker Pattern (Implicit via Timeouts)</h4>
<p><strong>Implementation:</strong> HTTP timeouts prevent cascading
failures</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">with</span> httpx.AsyncClient() <span class="im">as</span> client:</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> <span class="cf">await</span> client.post(</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>        CMS_MOCK_URL,</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>payload,</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="fl">10.0</span>  <span class="co"># Circuit opens if service slow</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    )</span></div></div>
<p><strong>Circuit States:</strong></p>
<pre><code>Closed → Normal operation
Open → Too many failures, reject requests
Half-Open → Test if service recovered</div>
<h3 id="security-patterns">10.7 Security Patterns</h3>
<h4 id="token-based-authentication">10.7.1 Token-Based
Authentication</h4>
<p><strong>Implementation:</strong> JWT</p>
<pre><code>1. User logs in → Server issues JWT
2. Client stores token
3. Client includes token in requests
4. Server validates token (stateless)</div>
<h4 id="password-hashing">10.7.2 Password Hashing</h4>
<p><strong>Implementation:</strong> bcrypt with salts</p>
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Salt automatically generated per password</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>hashed <span class="op">=</span> bcrypt.<span class="bu">hash</span>(<span class="st">&quot;password123&quot;</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: $2b$12$randomsalt$hashvalue</span></span></div></div>
<h4 id="rate-limiting">10.7.3 Rate Limiting</h4>
<p><strong>Implementation:</strong> SlowAPI</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="at">@router.post</span>(<span class="st">&quot;/login&quot;</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="at">@limiter.limit</span>(<span class="st">&quot;5/minute&quot;</span>)  <span class="co"># Max 5 requests per minute per IP</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> login(request: Request, ...):</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></div></div>
<h3 id="integration-patterns">10.8 Integration Patterns</h3>
<h4 id="protocol-translation">10.8.1 Protocol Translation</h4>
<p><strong>Implementation:</strong> Adapters</p>
<pre><code>JSON → SOAP (CMS Adapter)
JSON → REST (ROS Adapter)
JSON → TCP (WMS Adapter)</div>
<h4 id="message-routing">10.8.2 Message Routing</h4>
<p><strong>Implementation:</strong> RabbitMQ fanout exchange</p>
<pre><code>Single message → Multiple queues
Each adapter gets a copy</div>
<h4 id="message-transformation">10.8.3 Message Transformation</h4>
<p><strong>Implementation:</strong> Event enrichment</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adapter receives minimal order data</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> {<span class="st">&quot;orderId&quot;</span>: <span class="st">&quot;ORD-123&quot;</span>, <span class="st">&quot;customerId&quot;</span>: <span class="st">&quot;usr_456&quot;</span>}</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Adapter enriches with external data</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>customer_data <span class="op">=</span> call_cms(order[<span class="st">&#39;customerId&#39;</span>])</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Publishes enriched event</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>publish_event({</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;orderId&quot;</span>: order[<span class="st">&#39;orderId&#39;</span>],</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;customerName&quot;</span>: customer_data[<span class="st">&#39;name&#39;</span>],</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;customerTier&quot;</span>: customer_data[<span class="st">&#39;tier&#39;</span>]</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>})</span></div></div>
<h3 id="pattern-summary-table">10.9 Pattern Summary Table</h3>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 15%" />
<col style="width: 25%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="header">
<th>Pattern</th>
<th>Category</th>
<th>Implementation</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Microservices</strong></td>
<td>Architectural</td>
<td>Service decomposition</td>
<td>Independent services</td>
</tr>
<tr class="even">
<td><strong>Event-Driven</strong></td>
<td>Architectural</td>
<td>RabbitMQ</td>
<td>Async communication</td>
</tr>
<tr class="odd">
<td><strong>API Gateway</strong></td>
<td>Architectural</td>
<td>API Gateway service</td>
<td>Single entry point</td>
</tr>
<tr class="even">
<td><strong>Orchestration</strong></td>
<td>Architectural</td>
<td>Orchestrator service</td>
<td>Coordinate workflow</td>
</tr>
<tr class="odd">
<td><strong>Adapter</strong></td>
<td>Structural</td>
<td>Protocol adapters</td>
<td>Interface conversion</td>
</tr>
<tr class="even">
<td><strong>Façade</strong></td>
<td>Structural</td>
<td>MessageQueue class</td>
<td>Simplify Pika API</td>
</tr>
<tr class="odd">
<td><strong>Repository</strong></td>
<td>Structural</td>
<td>Beanie ODM</td>
<td>Data access abstraction</td>
</tr>
<tr class="even">
<td><strong>Observer</strong></td>
<td>Behavioral</td>
<td>Pub/Sub via RabbitMQ</td>
<td>Event notification</td>
</tr>
<tr class="odd">
<td><strong>Strategy</strong></td>
<td>Behavioral</td>
<td>Protocol strategies</td>
<td>Interchangeable algorithms</td>
</tr>
<tr class="even">
<td><strong>Middleware</strong></td>
<td>Behavioral</td>
<td>FastAPI middleware</td>
<td>Request pipeline</td>
</tr>
<tr class="odd">
<td><strong>Template Method</strong></td>
<td>Behavioral</td>
<td>Adapter base class</td>
<td>Algorithm skeleton</td>
</tr>
<tr class="even">
<td><strong>Singleton</strong></td>
<td>Creational</td>
<td>Database connection</td>
<td>Single instance</td>
</tr>
<tr class="odd">
<td><strong>Factory</strong></td>
<td>Creational</td>
<td>Order ID generation</td>
<td>Object creation</td>
</tr>
<tr class="even">
<td><strong>Active Object</strong></td>
<td>Concurrency</td>
<td>Message queue</td>
<td>Async execution</td>
</tr>
<tr class="odd">
<td><strong>Producer-Consumer</strong></td>
<td>Concurrency</td>
<td>Order pipeline</td>
<td>Work distribution</td>
</tr>
<tr class="even">
<td><strong>Retry</strong></td>
<td>Reliability</td>
<td>RabbitMQ requeue</td>
<td>Fault tolerance</td>
</tr>
<tr class="odd">
<td><strong>Idempotency</strong></td>
<td>Reliability</td>
<td>Unique order IDs</td>
<td>Safe retries</td>
</tr>
<tr class="even">
<td><strong>Circuit Breaker</strong></td>
<td>Reliability</td>
<td>HTTP timeouts</td>
<td>Prevent cascading failures</td>
</tr>
<tr class="odd">
<td><strong>Token Auth</strong></td>
<td>Security</td>
<td>JWT</td>
<td>Stateless authentication</td>
</tr>
<tr class="even">
<td><strong>Password Hashing</strong></td>
<td>Security</td>
<td>bcrypt</td>
<td>Credential security</td>
</tr>
<tr class="odd">
<td><strong>Rate Limiting</strong></td>
<td>Security</td>
<td>SlowAPI</td>
<td>Abuse prevention</td>
</tr>
<tr class="even">
<td><strong>Protocol Translation</strong></td>
<td>Integration</td>
<td>Adapters</td>
<td>Convert protocols</td>
</tr>
<tr class="odd">
<td><strong>Message Routing</strong></td>
<td>Integration</td>
<td>Fanout exchange</td>
<td>Broadcast messages</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="environment-configuration">11. Environment Configuration</h2>
<h3 id="environment-variables-reference">11.1 Environment Variables
Reference</h3>
<p><strong>Complete configuration from <a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/.env.example">.env.example</a>:</strong></p>
<h4 id="mongodb-configuration">MongoDB Configuration</h4>
<div class="sourceCode" id="cb97"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="va">MONGODB_URI</span><span class="op">=</span>mongodb://admin:admin123@mongodb:27017/swiftlogistics<span class="pp">?</span>authSource=admin</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="va">MONGO_INITDB_ROOT_USERNAME</span><span class="op">=</span>admin</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="va">MONGO_INITDB_ROOT_PASSWORD</span><span class="op">=</span>admin123</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="va">MONGO_INITDB_DATABASE</span><span class="op">=</span>swiftlogistics</span></div></div>
<p><strong>Purpose:</strong></p>
<ul>
<li>Connection string for MongoDB Atlas or local instance</li>
<li>Includes authentication credentials</li>
<li>Database name: <code>swiftlogistics</code></li>
<li>Auth source: <code>admin</code> (admin database)</li>
</ul>
<h4 id="rabbitmq-configuration">RabbitMQ Configuration</h4>
<div class="sourceCode" id="cb98"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="va">RABBITMQ_URL</span><span class="op">=</span>amqp://admin:admin123@rabbitmq:5672</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="va">RABBITMQ_DEFAULT_USER</span><span class="op">=</span>admin</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="va">RABBITMQ_DEFAULT_PASS</span><span class="op">=</span>admin123</span></div></div>
<p><strong>Purpose:</strong></p>
<ul>
<li>AMQP protocol connection string</li>
<li>Default credentials for RabbitMQ management</li>
<li>Port 5672: AMQP protocol</li>
<li>Port 15672: Management UI (not in connection string)</li>
</ul>
<h4 id="queue-names">Queue Names</h4>
<div class="sourceCode" id="cb99"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="va">ORDER_QUEUE</span><span class="op">=</span>new_order_queue</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="va">ORDER_EXCHANGE</span><span class="op">=</span>order_exchange</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="va">EVENTS_EXCHANGE</span><span class="op">=</span>events_exchange</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="va">EVENTS_QUEUE</span><span class="op">=</span>notification_events_queue</span></div></div>
<p><strong>Purpose:</strong></p>
<ul>
<li>Predefined queue and exchange names</li>
<li>Ensures consistency across all services</li>
<li>Can be customized per environment</li>
</ul>
<h4 id="service-ports">Service Ports</h4>
<div class="sourceCode" id="cb100"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="va">API_GATEWAY_PORT</span><span class="op">=</span>3000</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="va">ORCHESTRATOR_PORT</span><span class="op">=</span>3001</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="va">NOTIFICATION_SERVICE_PORT</span><span class="op">=</span>3002</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="va">CMS_MOCK_PORT</span><span class="op">=</span>4000</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="va">ROS_MOCK_PORT</span><span class="op">=</span>4001</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="va">WMS_MOCK_PORT</span><span class="op">=</span>4002</span></div></div>
<p><strong>Port Allocation:</strong></p>
<ul>
<li><strong>3000-3999:</strong> Core services</li>
<li><strong>4000-4999:</strong> Mock services</li>
<li><strong>5000+:</strong> Infrastructure (MongoDB: 27017, RabbitMQ:
5672, 15672)</li>
</ul>
<h4 id="service-urls">Service URLs</h4>
<div class="sourceCode" id="cb101"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="va">ORCHESTRATOR_URL</span><span class="op">=</span>http://orchestrator:3001</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="va">CMS_SOAP_URL</span><span class="op">=</span>http://cms-mock:4000/cms<span class="pp">?</span>wsdl</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="va">ROS_API_URL</span><span class="op">=</span>http://ros-mock:4001</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="va">WMS_TCP_HOST</span><span class="op">=</span>wms-mock</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="va">WMS_TCP_PORT</span><span class="op">=</span>4002</span></div></div>
<p><strong>Purpose:</strong></p>
<ul>
<li>Service discovery via Docker DNS</li>
<li>Container names resolve to internal IPs</li>
<li>No hardcoded IPs, portable across environments</li>
</ul>
<h4 id="security">Security</h4>
<div class="sourceCode" id="cb102"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="va">JWT_SECRET</span><span class="op">=</span>your-secret-key-change-in-production</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="va">NODE_ENV</span><span class="op">=</span>development</span></div></div>
<p><strong>⚠️ IMPORTANT:</strong></p>
<ul>
<li><strong>Change <code>JWT_SECRET</code> in production!</strong></li>
<li>Use cryptographically secure random string (256+ bits)</li>
<li>Example generation: <code>openssl rand -hex 32</code></li>
</ul>
<h4 id="rate-limiting-1">Rate Limiting</h4>
<div class="sourceCode" id="cb103"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="va">RATE_LIMIT_WINDOW_MS</span><span class="op">=</span>900000  <span class="co"># 15 minutes</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="va">RATE_LIMIT_MAX_REQUESTS</span><span class="op">=</span>100</span></div></div>
<p><strong>Configuration:</strong></p>
<ul>
<li>Window: 15 minutes (900,000 ms)</li>
<li>Max requests: 100 per window per IP</li>
<li>Prevents API abuse and DDoS</li>
</ul>
<h3 id="environment-specific-configuration">11.2 Environment-Specific
Configuration</h3>
<div class="mermaid">graph TB
    subgraph &quot;Development .env&quot;
        DevLog[LOG_LEVEL=DEBUG]
        DevDB[MONGODB_URI=localhost]
        DevCORS[CORS=*]
    end

    subgraph &quot;Staging .env&quot;
        StagLog[LOG_LEVEL=INFO]
        StagDB[MONGODB_URI=staging-db]
        StagCORS[CORS=staging-domain]
    end

    subgraph &quot;Production .env&quot;
        ProdLog[LOG_LEVEL=WARNING]
        ProdDB[MONGODB_URI=prod-cluster]
        ProdCORS[CORS=prod-domain]
        ProdJWT[JWT_SECRET=secure-random]
    end</div>
<p><strong>Best Practices:</strong></p>
<ul>
<li>Never commit <code>.env</code> files to Git</li>
<li>Use <code>.env.example</code> as template</li>
<li>Rotate secrets regularly in production</li>
<li>Use environment-specific values</li>
<li>Consider secret management tools (AWS Secrets Manager, HashiCorp
Vault)</li>
</ul>
<hr />
<h2 id="data-models-and-schemas">12. Data Models and Schemas</h2>
<h3 id="pydantic-requestresponse-schemas">12.1 Pydantic Request/Response
Schemas</h3>
<p>All schemas defined in <a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/models.py">common/models.py</a>:</p>
<h4 id="locationschema">LocationSchema</h4>
<div class="sourceCode" id="cb105"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LocationSchema(BaseModel):</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Geographic location.&quot;&quot;&quot;</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    lat: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=-</span><span class="dv">90</span>, le<span class="op">=</span><span class="dv">90</span>, description<span class="op">=</span><span class="st">&quot;Latitude&quot;</span>)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    lng: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=-</span><span class="dv">180</span>, le<span class="op">=</span><span class="dv">180</span>, description<span class="op">=</span><span class="st">&quot;Longitude&quot;</span>)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    address: Optional[<span class="bu">str</span>] <span class="op">=</span> Field(<span class="va">None</span>, description<span class="op">=</span><span class="st">&quot;Address string&quot;</span>)</span></div></div>
<p><strong>Validation:</strong></p>
<ul>
<li>Latitude: -90 to 90 (degrees)</li>
<li>Longitude: -180 to 180 (degrees)</li>
<li>Address: Optional string</li>
</ul>
<h4 id="packagedetailsschema">PackageDetailsSchema</h4>
<div class="sourceCode" id="cb106"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PackageDetailsSchema(BaseModel):</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Package information.&quot;&quot;&quot;</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    weight: <span class="bu">float</span> <span class="op">=</span> Field(..., gt<span class="op">=</span><span class="dv">0</span>, description<span class="op">=</span><span class="st">&quot;Weight in kg&quot;</span>)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    description: Optional[<span class="bu">str</span>] <span class="op">=</span> Field(<span class="va">None</span>, description<span class="op">=</span><span class="st">&quot;Package description&quot;</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    dimensions: Optional[Dict[<span class="bu">str</span>, <span class="bu">float</span>]] <span class="op">=</span> Field(<span class="va">None</span>, description<span class="op">=</span><span class="st">&quot;Dimensions&quot;</span>)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    fragile: <span class="bu">bool</span> <span class="op">=</span> Field(<span class="va">False</span>, description<span class="op">=</span><span class="st">&quot;Is package fragile&quot;</span>)</span></div></div>
<p><strong>Validation:</strong></p>
<ul>
<li>Weight: Must be &gt; 0</li>
<li>Dimensions: Dict with length/width/height</li>
<li>Fragile: Boolean flag (default: False)</li>
</ul>
<h4 id="ordercreaterequest">OrderCreateRequest</h4>
<div class="sourceCode" id="cb107"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderCreateRequest(BaseModel):</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Request schema for creating an order.&quot;&quot;&quot;</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    pickupLocation: LocationSchema</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    deliveryAddress: LocationSchema</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    packageDetails: PackageDetailsSchema</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    scheduledPickupTime: Optional[datetime] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    specialInstructions: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span></div></div>
<p><strong>Nested Validation:</strong></p>
<ul>
<li>Combines LocationSchema and PackageDetailsSchema</li>
<li>All nested validations cascade</li>
<li>Pydantic auto-validates on request</li>
</ul>
<h4 id="orderresponse">OrderResponse</h4>
<div class="sourceCode" id="cb108"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderResponse(BaseModel):</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Response schema for order.&quot;&quot;&quot;</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    orderId: <span class="bu">str</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    status: <span class="bu">str</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    message: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    customerId: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    createdAt: Optional[datetime] <span class="op">=</span> <span class="va">None</span></span></div></div>
<h4 id="userloginrequest">UserLoginRequest</h4>
<div class="sourceCode" id="cb109"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserLoginRequest(BaseModel):</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;User login request.&quot;&quot;&quot;</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    email: EmailStr  <span class="co"># Validates email format</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    password: <span class="bu">str</span></span></div></div>
<p><strong>EmailStr</strong> validates:</p>
<ul>
<li>Proper email format (regex)</li>
<li>No spaces</li>
<li>Contains <code>@</code> and domain</li>
</ul>
<h4 id="userregisterrequest">UserRegisterRequest</h4>
<div class="sourceCode" id="cb110"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserRegisterRequest(BaseModel):</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;User registration request.&quot;&quot;&quot;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field(..., min_length<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    email: EmailStr</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    password: <span class="bu">str</span> <span class="op">=</span> Field(..., min_length<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    phone: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    company: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span></div></div>
<p><strong>Validation:</strong></p>
<ul>
<li>Name: Minimum 2 characters</li>
<li>Password: Minimum 6 characters</li>
<li>Email: Valid format</li>
</ul>
<h4 id="tokenresponse">TokenResponse</h4>
<div class="sourceCode" id="cb111"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TokenResponse(BaseModel):</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Authentication token response.&quot;&quot;&quot;</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    token: <span class="bu">str</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    user: Dict[<span class="bu">str</span>, Any]</span></div></div>
<h4 id="healthresponse">HealthResponse</h4>
<div class="sourceCode" id="cb112"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthResponse(BaseModel):</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Health check response.&quot;&quot;&quot;</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    status: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;healthy&quot;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    service: <span class="bu">str</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    timestamp: datetime <span class="op">=</span> Field(default_factory<span class="op">=</span>datetime.utcnow)</span></div></div>
<h3 id="mongodb-document-schemas">12.2 MongoDB Document Schemas</h3>
<p><strong>Order Document</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/orchestrator/models/order.py">orchestrator/models/order.py</a>):</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Order(Document):</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Order document stored in MongoDB.&quot;&quot;&quot;</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    orderId: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">&quot;Unique order identifier&quot;</span>)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    customerId: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">&quot;Customer ID&quot;</span>)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Location data (stored as dicts for flexibility)</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    pickupLocation: Dict[<span class="bu">str</span>, Any]</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    deliveryAddress: Dict[<span class="bu">str</span>, Any]</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Package information</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    packageDetails: Dict[<span class="bu">str</span>, Any]</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order metadata</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    status: <span class="bu">str</span> <span class="op">=</span> Field(default<span class="op">=</span><span class="st">&quot;RECEIVED&quot;</span>, description<span class="op">=</span><span class="st">&quot;Order status&quot;</span>)</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>    createdAt: datetime <span class="op">=</span> Field(default_factory<span class="op">=</span>datetime.utcnow)</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>    updatedAt: datetime <span class="op">=</span> Field(default_factory<span class="op">=</span>datetime.utcnow)</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Integration status tracking</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>    integrationStatus: Dict[<span class="bu">str</span>, <span class="bu">str</span>] <span class="op">=</span> Field(</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>        default_factory<span class="op">=</span><span class="kw">lambda</span>: {</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;cms&quot;</span>: <span class="st">&quot;PENDING&quot;</span>,</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;ros&quot;</span>: <span class="st">&quot;PENDING&quot;</span>,</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;wms&quot;</span>: <span class="st">&quot;PENDING&quot;</span></span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional fields</span></span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>    scheduledPickupTime: Optional[datetime] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>    specialInstructions: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Settings:</span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> <span class="st">&quot;orders&quot;</span></span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>        indexes <span class="op">=</span> [</span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;orderId&quot;</span>,      <span class="co"># Unique order lookup</span></span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;customerId&quot;</span>,   <span class="co"># Customer&#39;s orders</span></span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;status&quot;</span>,       <span class="co"># Filter by status</span></span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;createdAt&quot;</span>     <span class="co"># Sort by date</span></span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>        ]</span></div></div>
<p><strong>MongoDB Indexes:</strong></p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="header">
<th>Index</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>orderId</code></td>
<td>Single field</td>
<td>Fast lookup by order ID (should be unique)</td>
</tr>
<tr class="even">
<td><code>customerId</code></td>
<td>Single field</td>
<td>Retrieve all orders for a customer</td>
</tr>
<tr class="odd">
<td><code>status</code></td>
<td>Single field</td>
<td>Filter orders by status (RECEIVED, PROCESSING, etc.)</td>
</tr>
<tr class="even">
<td><code>createdAt</code></td>
<td>Single field</td>
<td>Sort orders by creation date</td>
</tr>
</tbody>
</table>
<p><strong>Index Performance:</strong></p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Query with index</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>db<span class="op">.</span><span class="at">orders</span><span class="op">.</span><span class="fu">find</span>({ <span class="dt">orderId</span><span class="op">:</span> <span class="st">&quot;ORD-123&quot;</span> })<span class="op">;</span> <span class="co">// Uses orderId index, O(log n)</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Query without index</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>db<span class="op">.</span><span class="at">orders</span><span class="op">.</span><span class="fu">find</span>({ <span class="dt">specialInstructions</span><span class="op">:</span> <span class="st">&quot;Fragile&quot;</span> })<span class="op">;</span> <span class="co">// Collection scan, O(n)</span></span></div></div>
<p><strong>Collection Size Estimates:</strong></p>
<ul>
<li>Document size: ~500 bytes</li>
<li>1M orders: ~500 MB</li>
<li>Indexes: ~100 MB (4 indexes)</li>
<li>Total: ~600 MB</li>
</ul>
<hr />
<h2 id="api-endpoints-catalog">13. API Endpoints Catalog</h2>
<h3 id="api-gateway-endpoints">13.1 API Gateway Endpoints</h3>
<p><strong>Base URL:</strong> <code>http://localhost:3000</code></p>
<h4 id="authentication-endpoints">Authentication Endpoints</h4>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 31%" />
<col style="width: 6%" />
<col style="width: 15%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Path</th>
<th>Auth</th>
<th>Rate Limit</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>POST</td>
<td><code>/api/auth/login</code></td>
<td>No</td>
<td>5/min</td>
<td>User login, returns JWT</td>
</tr>
<tr class="even">
<td>POST</td>
<td><code>/api/auth/register</code></td>
<td>No</td>
<td>3/hour</td>
<td>User registration</td>
</tr>
</tbody>
</table>
<p><strong>Login Example:</strong></p>
<div class="sourceCode" id="cb115"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST http://localhost:3000/api/auth/login <span class="dt">\</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{&quot;email&quot;:&quot;john@example.com&quot;,&quot;password&quot;:&quot;password123&quot;}&#39;</span></span></div></div>
<p><strong>Response:</strong></p>
<div class="sourceCode" id="cb116"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;token&quot;</span><span class="fu">:</span> <span class="st">&quot;eyJhbGc...&quot;</span><span class="fu">,</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;user&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;usr_123&quot;</span><span class="fu">,</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;john@example.com&quot;</span><span class="fu">,</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;role&quot;</span><span class="fu">:</span> <span class="st">&quot;client&quot;</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<h4 id="order-endpoints">Order Endpoints</h4>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Path</th>
<th>Auth</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>POST</td>
<td><code>/api/orders</code></td>
<td>Required</td>
<td>Create new order</td>
</tr>
<tr class="even">
<td>GET</td>
<td><code>/api/orders/{order_id}</code></td>
<td>Required</td>
<td>Get order details</td>
</tr>
</tbody>
</table>
<p><strong>Create Order Example:</strong></p>
<div class="sourceCode" id="cb117"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST http://localhost:3000/api/orders <span class="dt">\</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Authorization: Bearer eyJhbGc...&quot;</span> <span class="dt">\</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&quot;Content-Type: application/json&quot;</span> <span class="dt">\</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;pickupLocation&quot;: {&quot;lat&quot;: 40.7128, &quot;lng&quot;: -74.0060, &quot;address&quot;: &quot;123 Main St&quot;},</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;deliveryAddress&quot;: {&quot;lat&quot;: 40.7589, &quot;lng&quot;: -73.9851, &quot;address&quot;: &quot;456 Oak Ave&quot;},</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;packageDetails&quot;: {&quot;weight&quot;: 5.5, &quot;description&quot;: &quot;Electronics&quot;, &quot;fragile&quot;: true}</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="st">  }&#39;</span></span></div></div>
<h4 id="driver-endpoints">Driver Endpoints</h4>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Path</th>
<th>Auth</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GET</td>
<td><code>/api/driver/location</code></td>
<td>Required</td>
<td>Get driver location</td>
</tr>
<tr class="even">
<td>GET</td>
<td><code>/api/driver/status</code></td>
<td>Required</td>
<td>Get driver status</td>
</tr>
</tbody>
</table>
<h4 id="health-check">Health Check</h4>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Path</th>
<th>Auth</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GET</td>
<td><code>/health</code></td>
<td>No</td>
<td>Service health status</td>
</tr>
</tbody>
</table>
<h3 id="orchestrator-endpoints">13.2 Orchestrator Endpoints</h3>
<p><strong>Base URL:</strong> <code>http://orchestrator:4000</code>
(internal only)</p>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>POST</td>
<td><code>/api/orders</code></td>
<td>Create order (called by gateway)</td>
</tr>
<tr class="even">
<td>GET</td>
<td><code>/api/orders/{order_id}</code></td>
<td>Get order details</td>
</tr>
<tr class="odd">
<td>GET</td>
<td><code>/health</code></td>
<td>Health check</td>
</tr>
</tbody>
</table>
<h3 id="mock-service-endpoints">13.3 Mock Service Endpoints</h3>
<h4 id="cms-mock-httpcms-mock3001">CMS Mock
(<code>http://cms-mock:3001</code>)</h4>
<p><strong>Capabilities:</strong></p>
<ul>
<li>Order intake &amp; management</li>
<li>Client contracts</li>
<li>Billing &amp; invoicing</li>
<li>Customer management</li>
<li>Driver management</li>
</ul>
<p><strong>Key Endpoints:</strong></p>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Path</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>POST</td>
<td><code>/api/auth/login</code></td>
<td>Authenticate user</td>
</tr>
<tr class="even">
<td>POST</td>
<td><code>/api/customers</code></td>
<td>Create customer</td>
</tr>
<tr class="odd">
<td>GET</td>
<td><code>/api/customers/{id}</code></td>
<td>Get customer</td>
</tr>
<tr class="even">
<td>POST</td>
<td><code>/api/orders</code></td>
<td>Create order</td>
</tr>
<tr class="odd">
<td>GET</td>
<td><code>/health</code></td>
<td>Health with entity counts</td>
</tr>
</tbody>
</table>
<p><strong>Health Response:</strong></p>
<div class="sourceCode" id="cb118"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;healthy&quot;</span><span class="fu">,</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;service&quot;</span><span class="fu">:</span> <span class="st">&quot;CMS Mock Service&quot;</span><span class="fu">,</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;2.0.0&quot;</span><span class="fu">,</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;entity_counts&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;customers&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;drivers&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">,</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;clients&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;admins&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;orders&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;contracts&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;invoices&quot;</span><span class="fu">:</span> <span class="dv">3</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></div></div>
<p><strong>Data Storage:</strong></p>
<ul>
<li>File-based JSON storage in <code>/app/data/</code></li>
<li>7 entity types: customers, drivers, clients, admins, orders,
contracts, invoices</li>
<li>Persisted via Docker volumes</li>
</ul>
<h4 id="ros-mock-httpros-mock3003">ROS Mock
(<code>http://ros-mock:3003</code>)</h4>
<p><strong>Capabilities:</strong></p>
<ul>
<li>Route optimization</li>
<li>ETA calculation</li>
<li>Distance computation</li>
</ul>
<h4 id="wms-mock-httpwms-mock3002">WMS Mock
(<code>http://wms-mock:3002</code>)</h4>
<p><strong>Capabilities:</strong></p>
<ul>
<li>Inventory management</li>
<li>Warehouse allocation</li>
<li>Picking location assignment</li>
</ul>
<hr />
<h2 id="error-handling-patterns">14. Error Handling Patterns</h2>
<h3 id="http-exception-handling">14.1 HTTP Exception Handling</h3>
<p><strong>API Gateway Pattern</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/api-gateway/routes/orders.py">api-gateway/routes/orders.py</a>):</p>
<div class="sourceCode" id="cb119"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Attempt operation</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> httpx.AsyncClient() <span class="im">as</span> client:</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> client.post(ORCHESTRATOR_URL, json<span class="op">=</span>data, timeout<span class="op">=</span><span class="fl">30.0</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="kw">in</span> [<span class="dv">200</span>, <span class="dv">202</span>]:</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> OrderResponse(<span class="op">**</span>response.json())</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span>response.status_code,</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>            detail<span class="op">=</span><span class="st">&quot;Failed to create order&quot;</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> httpx.TimeoutException:</span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    logger.error(<span class="st">&quot;Orchestrator service timeout&quot;</span>)</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> HTTPException(</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>        status_code<span class="op">=</span>status.HTTP_503_SERVICE_UNAVAILABLE,</span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>        detail<span class="op">=</span><span class="st">&quot;Order service temporarily unavailable&quot;</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> HTTPException:</span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span>  <span class="co"># Re-raise HTTP exceptions</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>    logger.error(<span class="ss">f&quot;Order creation error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> HTTPException(</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>        status_code<span class="op">=</span>status.HTTP_500_INTERNAL_SERVER_ERROR,</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>        detail<span class="op">=</span><span class="st">&quot;Failed to create order&quot;</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>    )</span></div></div>
<p><strong>Exception Hierarchy:</strong></p>
<pre><code>Exception
  └─ HTTPException (FastAPI)
       ├─ 400 Bad Request (validation failure)
       ├─ 401 Unauthorized (invalid/missing JWT)
       ├─ 404 Not Found (order not found)
       ├─ 503 Service Unavailable (timeout)
       └─ 500 Internal Server Error (unexpected errors)</div>
<h3 id="validation-errors">14.2 Validation Errors</h3>
<p><strong>Pydantic Validation:</strong></p>
<div class="sourceCode" id="cb121"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Invalid request</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;pickupLocation&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="dv">999</span>, <span class="st">&quot;lng&quot;</span>: <span class="dv">180</span>},  <span class="co"># Invalid lat</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;deliveryAddress&quot;</span>: {<span class="st">&quot;lat&quot;</span>: <span class="fl">40.7</span>, <span class="st">&quot;lng&quot;</span>: <span class="op">-</span><span class="fl">74.0</span>},</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;packageDetails&quot;</span>: {<span class="st">&quot;weight&quot;</span>: <span class="op">-</span><span class="dv">5</span>}  <span class="co"># Invalid weight</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Automatic response</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;detail&quot;</span>: [</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;loc&quot;</span>: [<span class="st">&quot;body&quot;</span>, <span class="st">&quot;pickupLocation&quot;</span>, <span class="st">&quot;lat&quot;</span>],</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;msg&quot;</span>: <span class="st">&quot;ensure this value is less than or equal to 90&quot;</span>,</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;type&quot;</span>: <span class="st">&quot;value_error.number.not_le&quot;</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;loc&quot;</span>: [<span class="st">&quot;body&quot;</span>, <span class="st">&quot;packageDetails&quot;</span>, <span class="st">&quot;weight&quot;</span>],</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;msg&quot;</span>: <span class="st">&quot;ensure this value is greater than 0&quot;</span>,</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;type&quot;</span>: <span class="st">&quot;value_error.number.not_gt&quot;</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>}</span></div></div>
<h3 id="rabbitmq-error-handling">14.3 RabbitMQ Error Handling</h3>
<p><strong>Message Processing Errors:</strong></p>
<div class="sourceCode" id="cb122"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(ch, method, properties, body):</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> json.loads(body)</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>        process_order(order)</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Success: Acknowledge message</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>        ch.basic_ack(delivery_tag<span class="op">=</span>method.delivery_tag)</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> json.JSONDecodeError <span class="im">as</span> e:</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f&quot;Invalid JSON: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Discard malformed messages (don&#39;t requeue)</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>        ch.basic_nack(delivery_tag<span class="op">=</span>method.delivery_tag, requeue<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f&quot;Processing error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Requeue for retry</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>        ch.basic_nack(delivery_tag<span class="op">=</span>method.delivery_tag, requeue<span class="op">=</span><span class="va">True</span>)</span></div></div>
<p><strong>Error Strategies:</strong></p>
<table>
<colgroup>
<col style="width: 32%" />
<col style="width: 21%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="header">
<th>Error Type</th>
<th>Strategy</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>JSON Parse Error</strong></td>
<td>NACK, no requeue</td>
<td>Malformed data won’t fix itself</td>
</tr>
<tr class="even">
<td><strong>Network Timeout</strong></td>
<td>NACK, requeue</td>
<td>Temporary issue, retry later</td>
</tr>
<tr class="odd">
<td><strong>External Service Down</strong></td>
<td>NACK, requeue</td>
<td>Service may recover</td>
</tr>
<tr class="even">
<td><strong>Business Logic Error</strong></td>
<td>NACK, no requeue</td>
<td>Invalid data, log for manual review</td>
</tr>
</tbody>
</table>
<h3 id="database-error-handling">14.4 Database Error Handling</h3>
<div class="sourceCode" id="cb123"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Attempt database operation</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> order.insert()</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> DuplicateKeyError:</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order ID already exists (idempotency)</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    logger.warning(<span class="ss">f&quot;Order </span><span class="sc">{</span>order_id<span class="sc">}</span><span class="ss"> already exists&quot;</span>)</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> HTTPException(status_code<span class="op">=</span><span class="dv">409</span>, detail<span class="op">=</span><span class="st">&quot;Order already exists&quot;</span>)</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> ConnectionFailure:</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>    logger.error(<span class="st">&quot;MongoDB connection failed&quot;</span>)</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> HTTPException(status_code<span class="op">=</span><span class="dv">503</span>, detail<span class="op">=</span><span class="st">&quot;Database unavailable&quot;</span>)</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>    logger.error(<span class="ss">f&quot;Database error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> HTTPException(status_code<span class="op">=</span><span class="dv">500</span>, detail<span class="op">=</span><span class="st">&quot;Database operation failed&quot;</span>)</span></div></div>
<hr />
<h2 id="logging-and-observability">15. Logging and Observability</h2>
<h3 id="logging-configuration">15.1 Logging Configuration</h3>
<p><strong>Loguru Setup</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/logging_config.py">common/logging_config.py</a>):</p>
<div class="sourceCode" id="cb124"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_logging(service_name: <span class="bu">str</span>):</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Configure logging for a service.&quot;&quot;&quot;</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    logger.remove()  <span class="co"># Remove default handler</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    log_level <span class="op">=</span> os.getenv(<span class="st">&quot;LOG_LEVEL&quot;</span>, <span class="st">&quot;INFO&quot;</span>)</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Console handler (colorized)</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    logger.add(</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>        sys.stdout,</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">format</span><span class="op">=</span><span class="st">&quot;&lt;green&gt;{time:YYYY-MM-DD HH:mm:ss}&lt;/green&gt; | &lt;level&gt;</span><span class="sc">{level: &lt;8}</span><span class="st">&lt;/level&gt; | &lt;cyan&gt;</span><span class="sc">{extra[service]}</span><span class="st">&lt;/cyan&gt; | &lt;level&gt;</span><span class="sc">{message}</span><span class="st">&lt;/level&gt;&quot;</span>,</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>        level<span class="op">=</span>log_level,</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>        colorize<span class="op">=</span><span class="va">True</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># File handler for errors only</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    logger.add(</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f&quot;logs/</span><span class="sc">{</span>service_name<span class="sc">}</span><span class="ss">_errors.log&quot;</span>,</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">format</span><span class="op">=</span><span class="st">&quot;{time:YYYY-MM-DD HH:mm:ss} | </span><span class="sc">{level}</span><span class="st"> | </span><span class="sc">{extra[service]}</span><span class="st"> | </span><span class="sc">{message}</span><span class="st">&quot;</span>,</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>        level<span class="op">=</span><span class="st">&quot;ERROR&quot;</span>,</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>        rotation<span class="op">=</span><span class="st">&quot;10 MB&quot;</span>,   <span class="co"># Rotate at 10MB</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>        retention<span class="op">=</span><span class="st">&quot;7 days&quot;</span>  <span class="co"># Keep for 7 days</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bind service name to all logs</span></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>    logger.configure(extra<span class="op">=</span>{<span class="st">&quot;service&quot;</span>: service_name})</span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> logger</span></div></div>
<p><strong>Log Levels:</strong></p>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 31%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="header">
<th>Level</th>
<th>Usage</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>DEBUG</strong></td>
<td>Development, detailed traces</td>
<td><code>logger.debug(f"Processing order: {order_data}")</code></td>
</tr>
<tr class="even">
<td><strong>INFO</strong></td>
<td>Normal operations</td>
<td><code>logger.info(f"Order created: {order_id}")</code></td>
</tr>
<tr class="odd">
<td><strong>WARNING</strong></td>
<td>Unexpected but handled</td>
<td><code>logger.warning(f"Retry attempt {retry_count}")</code></td>
</tr>
<tr class="even">
<td><strong>ERROR</strong></td>
<td>Errors requiring attention</td>
<td><code>logger.error(f"Database connection failed: {e}")</code></td>
</tr>
<tr class="odd">
<td><strong>CRITICAL</strong></td>
<td>System failure</td>
<td><code>logger.critical("RabbitMQ broker unreachable")</code></td>
</tr>
</tbody>
</table>
<p><strong>Log Output Example:</strong></p>
<pre><code>2026-02-04 21:30:15 | INFO     | orchestrator | Order created: ORD-1707091815-abc123
2026-02-04 21:30:16 | INFO     | orchestrator | Order published to queue: ORD-1707091815-abc123
2026-02-04 21:30:17 | ERROR    | cms-adapter  | CMS service timeout after 10s</div>
<h3 id="health-check-patterns">15.2 Health Check Patterns</h3>
<p><strong>Orchestrator Health Check:</strong></p>
<div class="sourceCode" id="cb126"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">&quot;/health&quot;</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> health():</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Comprehensive health check.&quot;&quot;&quot;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check MongoDB</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> Database.client.admin.command(<span class="st">&#39;ping&#39;</span>)</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>        db_status <span class="op">=</span> <span class="st">&quot;healthy&quot;</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>        db_status <span class="op">=</span> <span class="st">&quot;unhealthy&quot;</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check RabbitMQ</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>        message_queue.channel.basic_qos(prefetch_count<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>        mq_status <span class="op">=</span> <span class="st">&quot;healthy&quot;</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>        mq_status <span class="op">=</span> <span class="st">&quot;unhealthy&quot;</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>    overall_status <span class="op">=</span> <span class="st">&quot;healthy&quot;</span> <span class="cf">if</span> (db_status <span class="op">==</span> <span class="st">&quot;healthy&quot;</span> <span class="kw">and</span> mq_status <span class="op">==</span> <span class="st">&quot;healthy&quot;</span>) <span class="cf">else</span> <span class="st">&quot;degraded&quot;</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;status&quot;</span>: overall_status,</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;service&quot;</span>: <span class="st">&quot;orchestrator&quot;</span>,</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;dependencies&quot;</span>: {</span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;mongodb&quot;</span>: db_status,</span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;rabbitmq&quot;</span>: mq_status</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;timestamp&quot;</span>: datetime.utcnow().isoformat()</span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>    }</span></div></div>
<p><strong>Docker Health Checks:</strong></p>
<div class="sourceCode" id="cb127"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">healthcheck</span><span class="kw">:</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;CMD&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;curl&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;-f&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;http://localhost:3001/health&quot;</span><span class="kw">]</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">interval</span><span class="kw">:</span><span class="at"> 30s</span><span class="co"> # Check every 30 seconds</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">timeout</span><span class="kw">:</span><span class="at"> 10s</span><span class="co"> # Fail if no response in 10s</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">retries</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span><span class="co"> # Mark unhealthy after 3 failures</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">start_period</span><span class="kw">:</span><span class="at"> 40s</span><span class="co"> # Don&#39;t check for first 40s (startup time)</span></span></div></div>
<h3 id="distributed-tracing">15.3 Distributed Tracing</h3>
<p><strong>Order ID as Correlation ID:</strong></p>
<p>Every request generates or carries an <code>orderId</code> that flows
through all services:</p>
<pre><code>Frontend → API Gateway (add orderId to logs)
  → Orchestrator (log orderId)
    → RabbitMQ (orderId in message)
      → Adapters (log orderId)
        → External Services (pass orderId)
          → Notification (log orderId)
            → Frontend</div>
<p><strong>Example Trace:</strong></p>
<pre><code>[orchestrator] Order created: ORD-123
[orchestrator] Published to queue: ORD-123
[cms-adapter] Processing order: ORD-123
[cms-adapter] Sent to CMS: ORD-123
[ros-adapter] Processing order: ORD-123
[notification] Received event for: ORD-123
[notification] Emitted WebSocket update: ORD-123</div>
<hr />
<h2 id="service-startup-sequences">16. Service Startup Sequences</h2>
<h3 id="orchestrator-startup">16.1 Orchestrator Startup</h3>
<p><strong>Lifespan Management</strong> (<a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/orchestrator/main.py">orchestrator/main.py</a>):</p>
<div class="sourceCode" id="cb130"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="at">@asynccontextmanager</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> lifespan(app: FastAPI):</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== STARTUP =====</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;╔══════════════════════════════════════╗&quot;</span>)</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;║   Orchestrator Starting...           ║&quot;</span>)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;╚══════════════════════════════════════╝&quot;</span>)</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Connect to MongoDB</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> Database.connect_db([Order])</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Connect to RabbitMQ</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>    message_queue.<span class="ex">connect</span>()</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Declare exchanges (idempotent)</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>    message_queue.declare_exchange(<span class="st">&#39;order_exchange&#39;</span>, <span class="st">&#39;fanout&#39;</span>)</span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>    message_queue.declare_exchange(<span class="st">&#39;events_exchange&#39;</span>, <span class="st">&#39;fanout&#39;</span>)</span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;✓ Orchestrator ready&quot;</span>)</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span>  <span class="co"># Service runs here</span></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== SHUTDOWN =====</span></span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;Orchestrator shutting down...&quot;</span>)</span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> Database.close_db()</span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>    message_queue.close()</span></div></div>
<p><strong>Startup Sequence:</strong></p>
<div class="mermaid">sequenceDiagram
    participant D as Docker
    participant O as Orchestrator
    participant M as MongoDB
    participant R as RabbitMQ

    D-&gt;&gt;O: Start container
    Note over O: Run lifespan startup

   O-&gt;&gt;M: Connect (Motor)
    M--&gt;&gt;O: Connected ✓

    O-&gt;&gt;R: Connect (Pika)
    R--&gt;&gt;O: Connected ✓

    O-&gt;&gt;R: Declare order_exchange
    O-&gt;&gt;R: Declare events_exchange
    R--&gt;&gt;O: Exchanges ready ✓

    Note over O: Ready for requests</div>
<h3 id="api-gateway-startup">16.2 API Gateway Startup</h3>
<div class="sourceCode" id="cb132"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.on_event</span>(<span class="st">&quot;startup&quot;</span>)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> startup_event():</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;╔══════════════════════════════════════╗&quot;</span>)</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;║   API Gateway Starting...            ║&quot;</span>)</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;╚══════════════════════════════════════╝&quot;</span>)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f&quot;Environment: </span><span class="sc">{</span>os<span class="sc">.</span>getenv(<span class="st">&#39;NODE_ENV&#39;</span>, <span class="st">&#39;development&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f&quot;Port: 3000&quot;</span>)</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># No external dependencies to check</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Health checks happen on-demand via /health endpoint</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a><span class="at">@app.on_event</span>(<span class="st">&quot;shutdown&quot;</span>)</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> shutdown_event():</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;API Gateway shutting down...&quot;</span>)</span></div></div>
<h3 id="adapter-startup">16.3 Adapter Startup</h3>
<p><strong>CMS Adapter:</strong></p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="at">@asynccontextmanager</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> lifespan(app: FastAPI):</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;CMS Adapter Starting...&quot;</span>)</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start RabbitMQ consumer in background thread</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> consume_orders():</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>        mq.<span class="ex">connect</span>()</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>        mq.declare_exchange(<span class="st">&#39;order_exchange&#39;</span>, <span class="st">&#39;fanout&#39;</span>)</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>        queue_name <span class="op">=</span> mq.declare_queue(<span class="st">&#39;cms_order_queue&#39;</span>)</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>        mq.bind_queue(queue_name, <span class="st">&#39;order_exchange&#39;</span>)</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>        mq.consume(queue_name, callback)</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>    consumer_thread <span class="op">=</span> threading.Thread(target<span class="op">=</span>consume_orders, daemon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>    consumer_thread.start()</span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;✓ CMS Adapter ready&quot;</span>)</span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span></span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">&quot;CMS Adapter shutting down...&quot;</span>)</span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>    mq.close()</span></div></div>
<h3 id="docker-compose-startup-order">16.4 Docker Compose Startup
Order</h3>
<div class="sourceCode" id="cb134"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mongodb</span><span class="kw">:</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">condition</span><span class="kw">:</span><span class="at"> service_healthy</span><span class="co"> # Wait for MongoDB health check</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">rabbitmq</span><span class="kw">:</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">condition</span><span class="kw">:</span><span class="at"> service_healthy</span><span class="co"> # Wait for RabbitMQ health check</span></span></div></div>
<p><strong>Startup Flow:</strong></p>
<pre><code>1. MongoDB starts → health check passes → Ready
2. RabbitMQ starts → health check passes → Ready
3. Mocks start (cms-mock, ros-mock, wms-mock)
4. Orchestrator starts (depends on MongoDB + RabbitMQ)
5. API Gateway starts (depends on Orchestrator + CMS Mock)
6. Notification Service starts (depends on RabbitMQ)
7. Adapters start (depends on RabbitMQ + Orchestrator + respective mocks)</div>
<p><strong>Full System Startup Time:</strong></p>
<ul>
<li>Infrastructure (MongoDB + RabbitMQ): ~10-15 seconds</li>
<li>Mocks: ~5 seconds</li>
<li>Core services: ~5 seconds</li>
<li>Total: ~20-25 seconds</li>
</ul>
<hr />
<h2 id="docker-configuration-details">17. Docker Configuration
Details</h2>
<h3 id="docker-compose-service-matrix">17.1 Docker Compose Service
Matrix</h3>
<p><strong>Complete service configuration from <a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/docker-compose.yml">docker-compose.yml</a>:</strong></p>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 22%" />
<col style="width: 20%" />
<col style="width: 12%" />
<col style="width: 18%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="header">
<th>Service</th>
<th>Image/Build</th>
<th>Container Name</th>
<th>Ports</th>
<th>Volumes</th>
<th>Health Check</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>mongodb</strong></td>
<td>mongo:7.0</td>
<td>swiftlogistics-mongodb</td>
<td>27017:27017</td>
<td>mongodb_data:/data/db</td>
<td>mongosh ping</td>
</tr>
<tr class="even">
<td><strong>rabbitmq</strong></td>
<td>rabbitmq:3.12-management-alpine</td>
<td>swiftlogistics-rabbitmq</td>
<td>5672:5672, 15672:15672</td>
<td>rabbitmq_data:/var/lib/rabbitmq</td>
<td>rabbitmq-diagnostics</td>
</tr>
<tr class="odd">
<td><strong>cms-mock</strong></td>
<td>Build: ./services/mocks/cms-mock</td>
<td>swiftlogistics-cms-mock</td>
<td>3001:3001</td>
<td>./data:/app/data</td>
<td>curl /health</td>
</tr>
<tr class="even">
<td><strong>ros-mock</strong></td>
<td>Build: ./services/mocks/ros-mock</td>
<td>swiftlogistics-ros-mock</td>
<td>3003:3003</td>
<td>./data:/app/data</td>
<td>curl /health</td>
</tr>
<tr class="odd">
<td><strong>wms-mock</strong></td>
<td>Build: ./services/mocks/wms-mock</td>
<td>swiftlogistics-wms-mock</td>
<td>3002:3002</td>
<td>./data:/app/data</td>
<td>curl /health</td>
</tr>
<tr class="even">
<td><strong>orchestrator</strong></td>
<td>Build: ./services/orchestrator</td>
<td>swiftlogistics-orchestrator</td>
<td>4000:4000</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td><strong>api-gateway</strong></td>
<td>Build: ./services/api-gateway</td>
<td>swiftlogistics-api-gateway</td>
<td>3000:3000</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="even">
<td><strong>notification-service</strong></td>
<td>Build: ./services/notification-service</td>
<td>swiftlogistics-notification-service</td>
<td>3004:3004</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td><strong>cms-adapter</strong></td>
<td>Build: ./services/adapters/cms-adapter</td>
<td>swiftlogistics-cms-adapter</td>
<td>3005:3005</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="even">
<td><strong>ros-adapter</strong></td>
<td>Build: ./services/adapters/ros-adapter</td>
<td>swiftlogistics-ros-adapter</td>
<td>3006:3006</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td><strong>wms-adapter</strong></td>
<td>Build: ./services/adapters/wms-adapter</td>
<td>swiftlogistics-wms-adapter</td>
<td>3007:3007</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="network-configuration">17.2 Network Configuration</h3>
<div class="sourceCode" id="cb136"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">networks</span><span class="kw">:</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">swiftlogistics-network</span><span class="kw">:</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> bridge</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> swiftlogistics-network</span></span></div></div>
<p><strong>Network Features:</strong></p>
<ul>
<li><strong>Type:</strong> Bridge (default Docker network type)</li>
<li><strong>DNS:</strong> Automatic service discovery by container
name</li>
<li><strong>Isolation:</strong> All containers in same network can
communicate</li>
<li><strong>External Access:</strong> Only exposed ports accessible from
host</li>
</ul>
<h3 id="volume-configuration">17.3 Volume Configuration</h3>
<div class="sourceCode" id="cb137"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mongodb_data</span><span class="kw">:</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> swiftlogistics-mongodb-data</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">rabbitmq_data</span><span class="kw">:</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> swiftlogistics-rabbitmq-data</span></span></div></div>
<p><strong>Persistence:</strong></p>
<ul>
<li><strong>MongoDB:</strong> All database data persists across
container restarts</li>
<li><strong>RabbitMQ:</strong> Messages, queues, and configuration
persist</li>
<li><strong>Mock Data:</strong> JSON files mounted from host (live
reload)</li>
</ul>
<h3 id="restart-policies">17.4 Restart Policies</h3>
<div class="sourceCode" id="cb138"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">restart</span><span class="kw">:</span><span class="at"> on-failure</span></span></div></div>
<p><strong>Behavior:</strong></p>
<ul>
<li>Container restarts automatically if it exits with non-zero code</li>
<li>Does NOT restart if manually stopped</li>
<li>Does NOT restart if exit code is 0 (success)</li>
</ul>
<hr />
<h2 id="summary">Summary</h2>
<p>This document provides a <strong>complete and exhaustive</strong>
technical reference for the SwiftLogistics system architecture. Key
takeaways:</p>
<h3 id="architecture-design">Architecture &amp; Design</h3>
<ol type="1">
<li><strong>Hybrid Architecture:</strong> Microservices + Event-Driven +
Layered + API Gateway patterns</li>
<li><strong>11 Services:</strong> API Gateway, Orchestrator,
Notification, 3 Adapters, 3 Mocks, MongoDB, RabbitMQ</li>
<li><strong>5-Layer Structure:</strong> Presentation → Gateway →
Business Logic → Integration → External</li>
<li><strong>Scalability:</strong> Designed for horizontal scaling with
load balancer + multiple instances</li>
<li><strong>Quality Attributes:</strong> Performance (&lt;200ms),
Reliability (99.9%), Maintainability, Security</li>
</ol>
<h3 id="data-flows-communication">Data Flows &amp; Communication</h3>
<ol start="6" type="1">
<li><strong>Complete Order Lifecycle:</strong> User → Gateway →
Orchestrator → MongoDB → RabbitMQ → Adapters → External → Notification →
WebSocket</li>
<li><strong>RabbitMQ Architecture:</strong> 2 fanout exchanges, durable
queues, persistent messages, manual ACKs</li>
<li><strong>Event-Driven:</strong> 6 event types (ORDER_CREATED,
cms.success, ros.success, wms.success, order.update, order.new)</li>
<li><strong>Real-time Updates:</strong> WebSocket notifications via
Socket.IO with thread-to-async bridge</li>
</ol>
<h3 id="authentication-security">Authentication &amp; Security</h3>
<ol start="10" type="1">
<li><strong>JWT Authentication:</strong> HS256, 24-hour expiration,
stateless tokens</li>
<li><strong>Password Security:</strong> bcrypt with automatic salts</li>
<li><strong>Rate Limiting:</strong> 5 login attempts/min, 100 API
requests/15min per IP</li>
<li><strong>Input Validation:</strong> Pydantic schemas with
comprehensive validation rules</li>
<li><strong>CORS:</strong> Configurable allowed origins</li>
</ol>
<h3 id="integration-protocols">Integration &amp; Protocols</h3>
<ol start="15" type="1">
<li><strong>Adapter Pattern:</strong> Protocol translation for SOAP
(CMS), REST (ROS), and TCP (WMS)</li>
<li><strong>Message Transformation:</strong> Request enrichment for each
external system</li>
<li><strong>Error Handling:</strong> Retry with requeue, timeo uts,
circuit breakers</li>
</ol>
<h3 id="thread-safety-concurrency">Thread Safety &amp; Concurrency</h3>
<ol start="18" type="1">
<li><strong>Python GIL:</strong> Minimal impact due to I/O-bound
operations</li>
<li><strong>Connection Management:</strong> Isolated Pika connections
per thread, MongoDB connection pool (100 connections)</li>
<li><strong>Hybrid Concurrency:</strong> AsyncIO for HTTP, threading for
blocking RabbitMQ consumers</li>
<li><strong>Daemon Threads:</strong> Non-blocking process termination
for background consumers</li>
</ol>
<h3 id="data-models-schemas">Data Models &amp; Schemas</h3>
<ol start="22" type="1">
<li><strong>Pydantic Models:</strong> 6 request/response schemas with
automatic validation</li>
<li><strong>MongoDB Schema:</strong> Order document with 4 indexes for
optimal queries</li>
<li><strong>Validation Rules:</strong> Lat/lng ranges, weight &gt; 0,
email format, password min-length</li>
<li><strong>Integration Status Tracking:</strong> Per-adapter status
(cms/ros/wms: PENDING/SUCCESS/FAILED)</li>
</ol>
<h3 id="api-endpoints">API Endpoints</h3>
<ol start="26" type="1">
<li><strong>Authentication:</strong> POST /api/auth/login, POST
/api/auth/register</li>
<li><strong>Orders:</strong> POST /api/orders (create), GET
/api/orders/{id} (retrieve)</li>
<li><strong>Driver:</strong> GET /api/driver/location, GET
/api/driver/status</li>
<li><strong>Health Checks:</strong> All services expose /health for
monitoring</li>
<li><strong>Mock Capabilities:</strong> 7 entity types (customers,
drivers, orders, contracts, invoices, clients, admins)</li>
</ol>
<h3 id="environment-configuration-1">Environment Configuration</h3>
<ol start="31" type="1">
<li><strong>40+ Variables:</strong> MongoDB, RabbitMQ, JWT, ports, URLs,
rate limits</li>
<li><strong>Environment-Specific:</strong> Development, Staging,
Production configurations</li>
<li><strong>Secret Management:</strong> JWT secret rotation, no secrets
in code</li>
<li><strong>Service Discovery:</strong> Docker DNS resolution by
container name</li>
</ol>
<h3 id="error-handling">Error Handling</h3>
<ol start="35" type="1">
<li><strong>HTTP Exceptions:</strong> 400 (validation), 401 (auth), 404
(not found), 503 (timeout), 500 (server error)</li>
<li><strong>RabbitMQ Errors:</strong> Malformed messages discarded,
transient errors requeued</li>
<li><strong>Database Errors:</strong> Duplicate key (409), connection
failure (503), generic (500)</li>
<li><strong>Pydantic Validation:</strong> Automatic detailed error
responses with field-level messages</li>
</ol>
<h3 id="logging-observability">Logging &amp; Observability</h3>
<ol start="39" type="1">
<li><strong>Loguru Configuration:</strong> Colorized console + error
file rotation (10MB, 7 days)</li>
<li><strong>Log Levels:</strong> DEBUG, INFO, WARNING, ERROR,
CRITICAL</li>
<li><strong>Distributed Tracing:</strong> Order ID as correlation ID
across all services</li>
<li><strong>Health Checks:</strong> Docker healthchecks (30s interval, 3
retries, 40s start period)</li>
<li><strong>Dependency Monitoring:</strong> MongoDB + RabbitMQ status in
health endpoints</li>
</ol>
<h3 id="startup-deployment">Startup &amp; Deployment</h3>
<ol start="44" type="1">
<li><strong>Orchestrator Lifespan:</strong> MongoDB connection →
RabbitMQ connection → Exchange declaration</li>
<li><strong>Adapter Startup:</strong> Background thread for RabbitMQ
consumer</li>
<li><strong>Docker Compose:</strong> Dependency graph ensures correct
startup order</li>
<li><strong>Full System Startup:</strong> ~20-25 seconds (infrastructure
→ mocks → core → adapters)</li>
<li><strong>Restart Policies:</strong> Auto-restart on-failure for
resilience</li>
</ol>
<h3 id="docker-configuration">Docker Configuration</h3>
<ol start="49" type="1">
<li><strong>11 Services:</strong> Complete port mapping, container
names, volumes, health checks</li>
<li><strong>Network Isolation:</strong> Bridge network with internal
DNS</li>
<li><strong>Volume Persistence:</strong> MongoDB data, RabbitMQ data,
mock JSON files</li>
<li><strong>Health Checks:</strong> Automated container health
monitoring</li>
</ol>
<h3 id="design-patterns-2-3-patterns">Design Patterns (2 3+
Patterns)</h3>
<ol start="53" type="1">
<li><strong>Architectural:</strong> Microservices, Event-Driven,
Layered, API Gateway, Orchestration (Saga-like)</li>
<li><strong>Structural:</strong> Adapter, Façade, Repository</li>
<li><strong>Behavioral:</strong> Observer (Pub/Sub), Strategy,
Middleware, Template Method</li>
<li><strong>Creational:</strong> Singleton, Factory</li>
<li><strong>Concurrency:</strong> Active Object, Half-Sync/Half-Async,
Producer-Consumer</li>
<li><strong>Reliability:</strong> Retry, Idempotency, Circuit
Breaker</li>
<li><strong>Security:</strong> Token-Based Auth, Password Hashing, Rate
Limiting</li>
<li><strong>Integration:</strong> Protocol Translation, Message Routing,
Message Transformation</li>
</ol>
<hr />
<h2 id="document-statistics">Document Statistics</h2>
<table>
<thead>
<tr class="header">
<th>Metric</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Total Sections</strong></td>
<td>17 major sections</td>
</tr>
<tr class="even">
<td><strong>Total Subsections</strong></td>
<td>70+</td>
</tr>
<tr class="odd">
<td><strong>Total Lines</strong></td>
<td>3,500+</td>
</tr>
<tr class="even">
<td><strong>Code Examples</strong></td>
<td>80+</td>
</tr>
<tr class="odd">
<td><strong>Mermaid Diagrams</strong></td>
<td>25+ diagrams</td>
</tr>
<tr class="even">
<td><strong>Tables</strong></td>
<td>20+ comparison tables</td>
</tr>
<tr class="odd">
<td><strong>File References</strong></td>
<td>15+ with clickable links</td>
</tr>
<tr class="even">
<td><strong>Environment Variables</strong></td>
<td>40+ documented</td>
</tr>
<tr class="odd">
<td><strong>Design Patterns</strong></td>
<td>23+ cataloged</td>
</tr>
<tr class="even">
<td><strong>API Endpoints</strong></td>
<td>15+ documented</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="coverage-checklist">Coverage Checklist</h2>
<p>✅ <strong>Overall Architecture</strong> - Architectural styles,
layers, deployment topology, scalability, quality attributes,
constraints, decisions, future evolution<br />
✅ <strong>System Components</strong> - All 11 services with
responsibilities<br />
✅ <strong>Technology Stack</strong> - Complete with versions and
justifications<br />
✅ <strong>JWT Authentication</strong> - Token structure, creation,
validation, protected routes<br />
✅ <strong>RabbitMQ Messaging</strong> - Connection, exchanges, queues,
reliability, error handling<br />
✅ <strong>Order Lifecycle</strong> - End-to-end flow with sequence
diagrams<br />
✅ <strong>Event Architecture</strong> - All triggers, message
contracts, pub/sub patterns<br />
✅ <strong>Adapter Patterns</strong> - SOAP/REST/TCP protocol
translation<br />
✅ <strong>WebSocket Notifications</strong> - Real-time updates,
thread-to-async bridge<br />
✅ <strong>Thread Safety</strong> - GIL, connections, daemon threads,
concurrency model<br />
✅ <strong>Design Patterns</strong> - 23+ patterns with
implementations<br />
✅ <strong>Environment Configuration</strong> - 40+ variables with
descriptions<br />
✅ <strong>Data Models</strong> - Pydantic schemas + MongoDB documents
with indexes<br />
✅ <strong>API Endpoints</strong> - Complete catalog with examples<br />
✅ <strong>Error Handling</strong> - HTTP, validation, RabbitMQ,
database<br />
✅ <strong>Logging &amp; Observability</strong> - Loguru setup, health
checks, tracing<br />
✅ <strong>Startup Sequences</strong> - Service initialization with
diagrams<br />
✅ <strong>Docker Configuration</strong> - Services, networks, volumes,
health checks</p>
<hr />
<h2 id="usage">Usage</h2>
<p>This documentation serves multiple audiences:</p>
<p><strong>For Developers:</strong></p>
<ul>
<li>Understand system internals and data flows</li>
<li>Debug production issues with logging and tracing</li>
<li>Extend the system with new features</li>
<li>Follow established patterns and practices</li>
</ul>
<p><strong>For Architects:</strong></p>
<ul>
<li>Review design decisions and trade-offs</li>
<li>Plan for scalability and performance improvements</li>
<li>Understand quality attributes and constraints</li>
<li>Plan future enhancements (service mesh, multi-region)</li>
</ul>
<p><strong>For DevOps/SRE:</strong></p>
<ul>
<li>Deploy and manage the system</li>
<li>Monitor health and performance</li>
<li>Troubleshoot issues using logs and health checks</li>
<li>Scale services horizontally</li>
</ul>
<p><strong>For QA/Testers:</strong></p>
<ul>
<li>Write comprehensive integration tests</li>
<li>Test error scenarios and edge cases</li>
<li>Validate security and authentication</li>
<li>Test real-time notification delivery</li>
</ul>
<p><strong>For Students/Learners:</strong></p>
<ul>
<li>Study real-world architecture patterns</li>
<li>Learn microservices best practices</li>
<li>Understand event-driven systems</li>
<li>See design patterns in action</li>
</ul>
<hr />
<h2 id="references">References</h2>
<p>All code references in this document link to the actual
implementation files:</p>
<ul>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/auth.py">common/auth.py</a>
- JWT implementation</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/messaging.py">common/messaging.py</a>
- RabbitMQ wrapper</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/models.py">common/models.py</a>
- Pydantic schemas</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/database.py">common/database.py</a>
- MongoDB connection</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/common/logging_config.py">common/logging_config.py</a>
- Loguru setup</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/orchestrator/models/order.py">orchestrator/models/order.py</a>
- Order document</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/orchestrator/routes/orders.py">orchestrator/routes/orders.py</a>
- Order creation</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/services/api-gateway/routes/auth.py">api-gateway/routes/auth.py</a>
- Authentication endpoints</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/docker-compose.yml">docker-compose.yml</a>
- Complete deployment configuration</li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/.env.example">.env.example</a>
- Environment variables template</li>
</ul>
<hr />
<p><strong>Document Version:</strong> 2.0<br />
<strong>Last Updated:</strong> 2026-02-04<br />
<strong>Total Coverage:</strong> 100% of system components, data flows,
and implementation details</p>
<h3 id="data-flow-highlights">Data Flow Highlights</h3>
<ol type="1">
<li><strong>Synchronous Path:</strong> User → API Gateway → Orchestrator
→ Database (&lt; 100ms)</li>
<li><strong>Asynchronous Path:</strong> Orchestrator → RabbitMQ →
Adapters → External Services (parallel)</li>
<li><strong>Notification Path:</strong> Adapters → RabbitMQ →
Notification Service → WebSocket → User</li>
</ol>
<h3 id="jwt-security">JWT Security</h3>
<ul>
<li><strong>Algorithm:</strong> HS256 (HMAC-SHA256)</li>
<li><strong>Expiration:</strong> 24 hours</li>
<li><strong>Storage:</strong> Stateless (no server-side session)</li>
<li><strong>Validation:</strong> Every protected route via
middleware</li>
</ul>
<h3 id="rabbitmq-control-flow">RabbitMQ Control Flow</h3>
<ul>
<li><strong>Exchanges:</strong> Fanout type for broadcast
distribution</li>
<li><strong>Queues:</strong> Durable, persistent messages</li>
<li><strong>Reliability:</strong> Manual ACK, requeue on failure</li>
<li><strong>Threading:</strong> Blocking Pika in daemon threads</li>
</ul>
<h3 id="event-system">Event System</h3>
<ul>
<li><strong>Triggers:</strong> Order creation, adapter completion,
status changes</li>
<li><strong>Delivery:</strong> Pub/Sub pattern via RabbitMQ</li>
<li><strong>Real-time:</strong> WebSocket push to frontend</li>
</ul>
<h3 id="adapters">Adapters</h3>
<ul>
<li><strong>CMS:</strong> SOAP protocol for customer validation</li>
<li><strong>ROS:</strong> REST API for route optimization</li>
<li><strong>WMS:</strong> TCP socket for inventory management</li>
<li><strong>Pattern:</strong> Consume → Transform → Call → Publish →
ACK</li>
</ul>
<hr />
<p><strong>For detailed service-specific documentation,
see:</strong></p>
<ul>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/docs/services/api_gateway.md">API
Gateway</a></li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/docs/services/orchestrator.md">Orchestrator</a></li>
<li><a
href="file:///home/snake/UCSC/UCSC/Year%202/sem%202/Middleware%20Architecture%20SCS2314/Assignment%204/SwiftLogistics/docs/services/notification_service.md">Notification
Service</a></li>
</ul>
</body>
</html>
